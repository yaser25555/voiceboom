<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Voice Boom</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            overflow-x: hidden;
            position: relative;
            z-index: 0;

            background-image: url('background_image.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #2c3e50; /* لون احتياطي في حال عدم تحميل الصورة */
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6); /* طبقة شفافة لجعل النص أكثر وضوحاً */
            z-index: 1;
        }

        .container {
            background-color: rgba(33, 47, 60, 0.9); /* خلفية شفافة قليلاً للحاوية */
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 900px;
            width: 100%;
            z-index: 2; /* فوق طبقة الخلفية الشفافة */
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h1 {
            color: #f1c40f;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
        }

        #user-info {
            background-color: rgba(44, 62, 80, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        #user-info p {
            margin: 0;
            font-size: 1.1em;
            color: #ecf0f1;
        }

        #loggedInUsernameDisplay {
            font-weight: bold;
            color: #3498db;
        }

        #loggedInUsernameDisplay.admin {
            color: #e74c3c; /* لون أحمر للمدير */
        }

        #loggedInUserScore {
            font-weight: bold;
            color: #f1c40f;
        }

        #message {
            background-color: #34495e;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 1.2em;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .action-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.3em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-button:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .action-button.disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-button i {
            font-size: 1.5em;
        }

        /* أزرار العمليات المحددة */
        #autoButton { background-color: #27ae60; } /* أخضر */
        #autoButton:hover { background-color: #229954; }

        #tripleHitButton { background-color: #e67e22; } /* برتقالي */
        #tripleHitButton:hover { background-color: #d35400; }

        #hammerHitButton { background-color: #e74c3c; } /* أحمر */
        #hammerHitButton:hover { background-color: #c0392b; }

        /* منطقة الإعدادات (للمدير) */
        #settingsArea {
            background-color: rgba(44, 62, 80, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.3);
            text-align: left;
        }

        #settingsArea h2 {
            color: #f1c40f;
            margin-bottom: 20px;
            text-align: center;
        }

        .setting-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .setting-group label {
            flex: 1;
            font-size: 1.1em;
        }

        .setting-group input {
            flex: 2;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #34495e;
            background-color: #ecf0f1;
            color: #2c3e50;
            font-size: 1em;
        }

        .setting-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
        }

        #updateSettingsBtn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }

        #updateSettingsBtn:hover {
            background-color: #2980b9;
        }

        #gameSettingsMessage {
            margin-top: 15px;
            font-size: 1em;
            color: #ecf0f1;
        }

        #muteToggleBtn {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        #muteToggleBtn:hover {
            background-color: #8e44ad;
        }

        #logoutBtn {
            background-color: #c0392b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        #logoutBtn:hover {
            background-color: #a52d22;
        }

        .message-box {
            background-color: rgba(52, 73, 94, 0.8);
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 1.1em;
            text-align: center;
        }

        .message-box.success {
            background-color: #28a745; /* Bootstrap success green */
        }

        .message-box.error {
            background-color: #dc3545; /* Bootstrap error red */
        }
    </style>
</head>
<body>
    <audio id="backgroundMusic" src="background_music.mp3" loop autoplay></audio>

    <div class="container">
        <h1>Voice Boom Game</h1>
        <div id="user-info">
            <p>المستخدم: <span id="loggedInUsernameDisplay"></span></p>
            <p>النقاط: <span id="loggedInUserScore">0</span></p>
        </div>

        <div id="message"></div>

        <div class="button-group">
            <button id="autoButton" class="action-button">
                <i class="fas fa-hand-pointer"></i> تلقائي
            </button>
            <button id="tripleHitButton" class="action-button">
                <i class="fas fa-bullseye"></i> ضربة ثلاثية
            </button>
            <button id="hammerHitButton" class="action-button">
                <i class="fas fa-hammer"></i> ضربة المطرقة
            </button>
        </div>

        <button id="settingsToggleBtn" class="action-button">
            <i class="fas fa-cog"></i> إظهار الإعدادات
        </button>

        <div id="settingsArea">
            <h2>إعدادات اللعبة</h2>
            <div class="setting-group">
                <label for="currentPointsPerAnswer">نقاط لكل إجابة صحيحة:</label>
                <input type="number" id="currentPointsPerAnswer" value="10" min="1">
            </div>
            <div class="setting-group">
                <label for="currentTripleHitPoints">نقاط الضربة الثلاثية:</label>
                <input type="number" id="currentTripleHitPoints" value="30" min="1">
            </div>
            <div class="setting-group">
                <label for="currentHammerHitPoints">نقاط ضربة المطرقة:</label>
                <input type="number" id="currentHammerHitPoints" value="50" min="1">
            </div>
            <button id="updateSettingsBtn">تحديث الإعدادات</button>
            <p id="gameSettingsMessage"></p>
        </div>

        <div class="button-group" style="margin-top: 30px;">
            <button id="muteToggleBtn">
                <i class="fas fa-volume-up"></i> كتم الصوت
            </button>
            <button id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://voiceboom-wlxp.onrender.com'; // عنوان الـ API للواجهة الخلفية

        const loggedInUsernameDisplay = document.getElementById('loggedInUsernameDisplay');
        const loggedInUserScore = document.getElementById('loggedInUserScore');
        const messageDisplay = document.getElementById('message');
        const autoButton = document.getElementById('autoButton');
        const tripleHitButton = document.getElementById('tripleHitButton');
        const hammerHitButton = document.getElementById('hammerHitButton');
        const settingsToggleBtn = document.getElementById('settingsToggleBtn');
        const settingsArea = document.getElementById('settingsArea');
        const updateSettingsBtn = document.getElementById('updateSettingsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const muteToggleBtn = document.getElementById('muteToggleBtn');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const gameSettingsMessage = document.getElementById('gameSettingsMessage'); // للتأكد من وجود العنصر

        let currentPointsPerAnswer = 10;
        let currentTripleHitPoints = 30;
        let currentHammerHitPoints = 50;

        // دالة لعرض الرسائل للمستخدم
        function showMessage(msg, type = 'info') {
            messageDisplay.textContent = msg;
            messageDisplay.className = 'message-box'; // reset classes
            if (type === 'success') {
                messageDisplay.classList.add('success');
            } else if (type === 'error') {
                messageDisplay.classList.add('error');
            }
        }

        // دالة لجلب بيانات المستخدم
        async function fetchUserData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No token, authorization denied');
                }
                const response = await fetch(`${API_BASE_URL}/api/user/data`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json(); // قد تفشل إذا لم تكن الاستجابة JSON
                    throw new Error(errorData.message || 'فشل في جلب بيانات المستخدم');
                }
                const data = await response.json();
                loggedInUserScore.textContent = data.score;
                showMessage('تم تحديث بيانات المستخدم بنجاح.', 'success');
            } catch (error) {
                console.error('Error fetching user data:', error);
                loggedInUserScore.textContent = 'خطأ في جلب النقاط.';
                showMessage(error.message || 'فشل في جلب بيانات المستخدم.', 'error');
                // إذا فشل جلب بيانات المستخدم بسبب عدم المصادقة، أعد التوجيه
                if (error.message.includes('authorization denied') || (error.message.includes('401') && !window.location.href.includes('index.html'))) {
                    alert('انتهت صلاحية الجلسة أو غير مصرح لك. الرجاء تسجيل الدخول مرة أخرى.');
                    window.location.href = 'index.html';
                }
            }
        }

        // دالة لجلب إعدادات اللعبة (تم تعديلها لإرسال التوكن)
        async function getGameSettings() {
            try {
                const token = localStorage.getItem('token'); // جلب التوكن
                if (!token) {
                    throw new Error('No token, authorization denied for settings');
                }

                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'GET', // تحديد طريقة الطلب
                    headers: {
                        'Authorization': `Bearer ${token}` // إرسال التوكن في رأس الطلب
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json(); // قد تفشل إذا لم تكن الاستجابة JSON
                    throw new Error(errorData.message || 'فشل في جلب إعدادات اللعبة');
                }
                const settings = await response.json();
                // تحديث واجهة المستخدم بالإعدادات
                document.getElementById('currentPointsPerAnswer').value = settings.pointsPerAnswer || 10;
                document.getElementById('currentTripleHitPoints').value = settings.tripleHitPoints || 30;
                document.getElementById('currentHammerHitPoints').value = settings.hammerHitPoints || 50;
                currentPointsPerAnswer = settings.pointsPerAnswer || 10;
                currentTripleHitPoints = settings.tripleHitPoints || 30;
                currentHammerHitPoints = settings.hammerHitPoints || 50;
                showMessage('تم تحميل إعدادات اللعبة بنجاح.', 'success');
            } catch (error) {
                console.error('Error fetching game settings:', error);
                showMessage(error.message || 'فشل في تحميل إعدادات اللعبة.', 'error');
                // إذا فشل جلب الإعدادات بسبب عدم المصادقة، أعد التوجيه
                if (error.message.includes('authorization denied') || (error.message.includes('401') && !window.location.href.includes('index.html'))) {
                    alert('انتهت صلاحية الجلسة أو غير مصرح لك. الرجاء تسجيل الدخول مرة أخرى.');
                    window.location.href = 'index.html';
                }
            }
        }

        // دالة لتحديث إعدادات اللعبة (محمي للمدير)
        async function updateGameSettings() {
            const newPointsPerAnswer = document.getElementById('currentPointsPerAnswer').value;
            const newTripleHitPoints = document.getElementById('currentTripleHitPoints').value;
            const newHammerHitPoints = document.getElementById('currentHammerHitPoints').value;

            const token = localStorage.getItem('token');
            if (!token) {
                alert('لا يوجد توكن، غير مصرح لك بتحديث الإعدادات.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        pointsPerAnswer: parseInt(newPointsPerAnswer),
                        tripleHitPoints: parseInt(newTripleHitPoints),
                        hammerHitPoints: parseInt(newHammerHitPoints)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'فشل في تحديث إعدادات اللعبة');
                }
                const data = await response.json();
                currentPointsPerAnswer = data.settings.pointsPerAnswer;
                currentTripleHitPoints = data.settings.tripleHitPoints;
                currentHammerHitPoints = data.settings.hammerHitPoints;
                showMessage('تم تحديث إعدادات اللعبة بنجاح!', 'success');
            } catch (error) {
                console.error('Error updating game settings:', error);
                showMessage(error.message || 'فشل في تحديث إعدادات اللعبة.', 'error');
                if (error.message.includes('authorization denied') || (error.message.includes('401') && !window.location.href.includes('index.html'))) {
                    alert('انتهت صلاحية الجلسة أو غير مصرح لك. الرجاء تسجيل الدخول مرة أخرى.');
                    window.location.href = 'index.html';
                }
            }
        }

        // دالة لتحديث نقاط المستخدم (مثلاً بعد إجابة صحيحة)
        async function updateScore(pointsToAdd) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('لا يوجد توكن، غير مصرح لك بتحديث النقاط.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/user/score`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ score: pointsToAdd })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'فشل في تحديث النقاط');
                }
                const data = await response.json();
                loggedInUserScore.textContent = data.newScore;
                showMessage(`تم إضافة ${pointsToAdd} نقطة. نقاطك الجديدة: ${data.newScore}`, 'success');
            } catch (error) {
                console.error('Error updating score:', error);
                showMessage(error.message || 'فشل في تحديث النقاط.', 'error');
                if (error.message.includes('authorization denied') || (error.message.includes('401') && !window.location.href.includes('index.html'))) {
                    alert('انتهت صلاحية الجلسة أو غير مصرح لك. الرجاء تسجيل الدخول مرة أخرى.');
                    window.location.href = 'index.html';
                }
            }
        }

        // دوال لعمليات اللعبة
        async function autoHit() {
            showMessage('تلقائي: كشف عن الإجابة! النقاط: ' + currentPointsPerAnswer, 'info');
            await updateScore(currentPointsPerAnswer);
        }

        async function tripleHit() {
            showMessage('ضربة ثلاثية: نقاط إضافية! النقاط: ' + currentTripleHitPoints, 'info');
            await updateScore(currentTripleHitPoints);
        }

        async function hammerHit() {
            showMessage('ضربة المطرقة: أقوى ضربة! النقاط: ' + currentHammerHitPoints, 'info');
            await updateScore(currentHammerHitPoints);
        }

        // دالة لكتم/إلغاء كتم الموسيقى
        function toggleMute() {
            if (backgroundMusic) {
                backgroundMusic.muted = !backgroundMusic.muted;
                muteToggleBtn.innerHTML = backgroundMusic.muted ? '<i class="fas fa-volume-off"></i> إلغاء كتم الصوت' : '<i class="fas fa-volume-up"></i> كتم الصوت';
            }
        }

        // دالة لتحديث حالة أزرار العمليات (متاحة/معطلة)
        function updateActionButtonsState() {
            // منطق لتعطيل/تفعيل الأزرار بناءً على حالة اللعبة، مثلاً إذا كان هناك سؤال معروض
            // حالياً، لن نقوم بتعطيلها
        }

        // دالة لتحديث رؤية الأزرار (إذا كان هناك منطق خاص)
        function updateButtonVisibility() {
            // يمكن إضافة منطق هنا إذا كانت بعض الأزرار يجب أن تظهر فقط في حالات معينة
        }

        // معالج حدث تسجيل الخروج
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('isAdmin');
            window.location.href = 'index.html';
        });

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            const isAdmin = localStorage.getItem('isAdmin') === 'true'; // تحويل السلسلة النصية إلى قيمة منطقية

            if (token && username) {
                loggedInUsernameDisplay.textContent = username;
                if (isAdmin) {
                    loggedInUsernameDisplay.classList.add('admin');
                }

                // تحميل بيانات المستخدم وإعدادات اللعبة
                await fetchUserData(); // سيقوم الآن بالتحقق من التوكن ويرسل 401 إذا لم يجده
                await getGameSettings(); // تم تعديلها لإرسال التوكن

                // تهيئة معالجات الأحداث للأزرار
                autoButton.addEventListener('click', autoHit);
                tripleHitButton.addEventListener('click', tripleHit);
                hammerHitButton.addEventListener('click', hammerHit);
                updateSettingsBtn.addEventListener('click', updateGameSettings);
                muteToggleBtn.addEventListener('click', toggleMute);

                if (isAdmin) {
                    settingsToggleBtn.style.display = 'block';
                    settingsArea.style.display = 'none'; // إخفاء الإعدادات في البداية
                    settingsToggleBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';

                    settingsToggleBtn.addEventListener('click', () => {
                        if (settingsArea.style.display === 'none') {
                            settingsArea.style.display = 'block';
                            settingsToggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء الإعدادات';
                        } else {
                            settingsArea.style.display = 'none';
                            settingsToggleBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
                        }
                    });

                } else {
                    settingsToggleBtn.style.display = 'none';
                    settingsArea.style.display = 'none';
                }

                showMessage('اضغط "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" للكشف عن النقاط!');
                updateButtonVisibility();
                updateActionButtonsState();

            } else {
                // إذا لم يكن هناك توكن أو اسم مستخدم عند التحميل الأولي، أعد التوجيه
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>