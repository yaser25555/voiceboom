<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Voice Boom</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-bg-color: #2c3e50; /* لون خلفية أساسي داكن */
            --secondary-color: #34495e; /* لون ثانوي أغمق قليلاً */
            --accent-color-1: #e74c3c; /* أحمر جذاب للأزرار أو الرسائل (مثل الأخطاء أو النقاط السالبة) */
            --accent-color-2: #2ecc71; /* أخضر للنجاح */
            --text-color-light: #ecf0f1; /* نص فاتح */
            --text-color-dark: #34495e; /* نص داكن */
            --border-color: #7f8c8d; /* لون الحدود */
            --box-bg-color: rgba(44, 62, 80, 0.8); /* خلفية الصندوق شبه شفافة */
            --button-bg-hover: #3b506b; /* لون زر عند التحويم */
            --admin-panel-bg: rgba(52, 73, 94, 0.9); /* خلفية لوحة الإدارة */
        }

        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            color: var(--text-color-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            overflow-x: hidden; /* لمنع ظهور شريط التمرير الأفقي */
            position: relative;
            z-index: 0;

            /* الخلفية الأساسية - سيتم تجاوزها بواسطة JS من إعدادات السيرفر */
            background-image: url('default_background.jpg'); /* صورة افتراضية */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out; /* انتقال سلس للخلفية */
        }

        /* تراكب داكن على الخلفية لجعل النص أكثر وضوحًا */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* طبقة شفافة سوداء */
            z-index: -1; /* للتأكد من أنها خلف المحتوى */
        }

        header {
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background-color: var(--secondary-color);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            animation: fadeInDown 0.8s ease-out;
            flex-wrap: wrap; /* للسماح للعناصر بالانتقال إلى سطر جديد على الشاشات الصغيرة */
        }

        .user-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* مسافة بين عناصر معلومات المستخدم */
        }

        .user-info span {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color-light);
            display: inline-flex; /* لجعل الأيقونة والنص في سطر واحد */
            align-items: center;
        }

        .user-info span i {
            margin-left: 8px; /* مسافة بين الأيقونة والنص في RTL */
            color: #f1c40f; /* لون ذهبي للأيقونات */
        }

        .header-actions {
            display: flex;
            gap: 10px;
            margin-right: auto; /* يدفع الأزرار إلى أقصى اليسار في RTL */
        }

        #gameMessage {
            background-color: var(--accent-color-1); /* افتراضي للأخطاء أو رسائل التحذير */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.6s ease-out;
        }

        #gameContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 900px;
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out;
        }

        .game-box {
            background-color: var(--box-bg-color);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden; /* لإخفاء أي عناصر تخرج عن حدود الصندوق */
        }

        .game-box:hover {
            transform: translateY(-5px);
            background-color: var(--button-bg-hover);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .game-box.revealed {
            background-color: var(--accent-color-2); /* لون أخضر عند الكشف عن نقاط إيجابية */
            color: white;
            cursor: default;
            transform: scale(1.05); /* تكبير بسيط عند الكشف */
        }
        
        .game-box.revealed.negative {
            background-color: var(--accent-color-1); /* لون أحمر للنقاط السالبة */
        }

        .game-box .content {
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .game-box.revealed .content {
            opacity: 1;
            transform: scale(1);
        }

        .game-actions {
            display: flex;
            flex-wrap: wrap; /* للسماح للأزرار بالانتقال إلى سطر جديد */
            justify-content: center;
            gap: 15px;
            width: 100%;
            max-width: 900px;
            margin-bottom: 20px;
            animation: fadeIn 1s ease-out;
        }

        .action-button {
            background-color: var(--accent-color-1);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* للسماح للأزرار بالتمدد */
            max-width: 250px; /* لتحديد عرض أقصى */
        }

        .action-button i {
            margin-left: 10px; /* مسافة بين الأيقونة والنص */
        }

        .action-button:hover:not(:disabled) {
            background-color: #c0392b; /* لون أحمر أغمق عند التحويم */
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .action-button:disabled {
            background-color: #7f8c8d; /* لون رمادي عند التعطيل */
            cursor: not-allowed;
            opacity: 0.7;
        }

        .info-panel {
            background-color: var(--secondary-color);
            color: var(--text-color-light);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            font-size: 1.1em;
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
            margin-bottom: 20px; /* لترك مسافة للفوتر */
            animation: fadeIn 0.8s ease-out;
        }

        /* لوحة الإعدادات للمشرف */
        #settingsArea {
            background-color: var(--admin-panel-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 700px;
            margin-top: 20px;
            display: none; /* مخفية افتراضياً */
            animation: slideInUp 0.6s ease-out;
        }

        #settingsArea h2 {
            text-align: center;
            color: var(--accent-color-2);
            margin-bottom: 25px;
            font-size: 1.8em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .settings-group {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .settings-group h3 {
            color: var(--accent-color-1);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color-light);
            font-size: 0.95em;
        }

        .setting-item input[type="number"],
        .setting-item input[type="text"],
        .setting-item input[type="url"] {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color-light);
            font-size: 1em;
        }

        .setting-item input[type="number"]::-webkit-inner-spin-button,
        .setting-item input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .setting-item input[type="number"] {
            -moz-appearance: textfield;
        }

        .settings-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .settings-actions button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #saveSettingsBtn {
            background-color: var(--accent-color-2);
            color: white;
        }

        #saveSettingsBtn:hover {
            background-color: #27ae60;
            transform: translateY(-3px);
        }

        #resetGameBtn {
            background-color: var(--accent-color-1);
            color: white;
        }

        #resetGameBtn:hover {
            background-color: #c0392b;
            transform: translateY(-3px);
        }

        /* زر كتم الصوت */
        #muteToggleBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
            z-index: 1000;
        }

        #muteToggleBtn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        footer {
            margin-top: auto; /* يدفع الفوتر إلى الأسفل */
            padding-top: 20px;
            color: var(--text-color-light);
            font-size: 0.9em;
            opacity: 0.8;
            text-align: center;
            width: 100%;
            max-width: 900px;
        }

        /* استجابة للتصميم */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 15px;
            }

            .user-info {
                margin-bottom: 10px;
                justify-content: center;
            }
            .header-actions {
                margin-right: 0; /* لإلغاء الدفع لليسار على الشاشات الصغيرة */
                justify-content: center;
                width: 100%;
            }

            .user-info span {
                font-size: 1em;
                margin: 0 8px;
            }

            #gameContainer {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
                padding: 15px;
            }

            .game-box {
                height: 100px;
            }

            .action-button {
                width: 100%;
                max-width: none;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>
    <header>
        <div class="user-info">
            <span><i class="fas fa-user"></i> <span id="usernameDisplay">اللاعب: غير معروف</span></span>
            <span><i class="fas fa-coins"></i> العملات: <span id="playerCoinsDisplay">0</span></span>
            <span><i class="fas fa-star"></i> النقاط المحظوظة: <span id="luckyPointsDisplay">0</span></span>
        </div>
        <div class="header-actions">
            <button id="logoutBtn" class="action-button"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            <button id="toggleSettingsBtn" class="action-button" style="display: none;"><i class="fas fa-cog"></i> إظهار الإعدادات</button>
        </div>
    </header>

    <div id="gameMessage">مرحباً بك في Voice Boom!</div>

    <div id="gameContainer">
        </div>

    <div class="game-actions">
        <button id="autoPlayBtn" class="action-button"><i class="fas fa-robot"></i> تلقائي (<span id="autoPlayCostDisplay">0</span> عملة)</button>
        <button id="tripleStrikeBtn" class="action-button"><i class="fas fa-hand-sparkles"></i> ضربة ثلاثية (<span id="tripleStrikeCostDisplay">0</span> عملة)</button>
        <button id="hammerStrikeBtn" class="action-button"><i class="fas fa-hammer"></i> ضربة المطرقة (<span id="hammerStrikeCostDisplay">0</span> عملة)</button>
    </div>

    <div class="info-panel">
        <p>جولات اللعب: <span id="roundsPlayedDisplay">0</span></p>
    </div>

    <div id="settingsArea">
        <h2>إعدادات اللعبة (للمشرفين فقط)</h2>
        <div class="settings-grid">
            <div class="settings-group">
                <h3>إعدادات الصناديق</h3>
                <div class="setting-item">
                    <label for="numBoxes">عدد الصناديق الإجمالي:</label>
                    <input type="number" id="numBoxes" min="1" value="10">
                </div>
                <div class="setting-item">
                    <label for="num10PointsBoxes">عدد صناديق +10 نقاط:</label>
                    <input type="number" id="num10PointsBoxes" min="0" value="1">
                </div>
                <div class="setting-item">
                    <label for="num5PointsBoxes">عدد صناديق +5 نقاط:</label>
                    <input type="number" id="num5PointsBoxes" min="0" value="2">
                </div>
                <div class="setting-item">
                    <label for="num1PointsBoxes">عدد صناديق +1 نقطة:</label>
                    <input type="number" id="num1PointsBoxes" min="0" value="3">
                </div>
                <div class="setting-item">
                    <label for="numNegative5PointsBoxes">عدد صناديق -5 نقاط:</label>
                    <input type="number" id="numNegative5PointsBoxes" min="0" value="1">
                </div>
                <div class="setting-item">
                    <label for="numNegative10PointsBoxes">عدد صناديق -10 نقاط:</label>
                    <input type="number" id="numNegative10PointsBoxes" min="0" value="0">
                </div>
            </div>

            <div class="settings-group">
                <h3>إعدادات العملات والإجراءات</h3>
                <div class="setting-item">
                    <label for="initialCoins">العملات الأولية للاعبين الجدد:</label>
                    <input type="number" id="initialCoins" min="0" value="500">
                </div>
                <div class="setting-item">
                    <label for="autoPlayCost">تكلفة اللعب التلقائي:</label>
                    <input type="number" id="autoPlayCost" min="0" value="100">
                </div>
                <div class="setting-item">
                    <label for="autoPlayMaxPrize">مكافأة اللعب التلقائي القصوى:</label>
                    <input type="number" id="autoPlayMaxPrize" min="0" value="20">
                </div>
                <div class="setting-item">
                    <label for="tripleStrikeCost">تكلفة الضربة الثلاثية:</label>
                    <input type="number" id="tripleStrikeCost" min="0" value="150">
                </div>
                <div class="setting-item">
                    <label for="tripleStrikeMaxPrize">مكافأة الضربة الثلاثية القصوى:</label>
                    <input type="number" id="tripleStrikeMaxPrize" min="0" value="30">
                </div>
                <div class="setting-item">
                    <label for="tripleStrikeLuckyChance">فرصة الحظ للضربة الثلاثية (0-1):</label>
                    <input type="number" id="tripleStrikeLuckyChance" min="0" max="1" step="0.01" value="0.1">
                </div>
                <div class="setting-item">
                    <label for="tripleHitPoints">نقاط الضربة المحظوظة الثلاثية:</label>
                    <input type="number" id="tripleHitPoints" min="0" value="30">
                </div>
                <div class="setting-item">
                    <label for="hammerStrikeCost">تكلفة ضربة المطرقة:</label>
                    <input type="number" id="hammerStrikeCost" min="0" value="200">
                </div>
                <div class="setting-item">
                    <label for="hammerHitPoints">نقاط ضربة المطرقة المحظوظة:</label>
                    <input type="number" id="hammerHitPoints" min="0" value="50">
                </div>
            </div>

            <div class="settings-group">
                <h3>إعدادات التصميم (URL)</h3>
                <div class="setting-item">
                    <label for="backgroundImgUrl">رابط صورة الخلفية:</label>
                    <input type="url" id="backgroundImgUrl" value="background_image.jpg">
                </div>
                <div class="setting-item">
                    <label for="audioPathUrl">رابط ملف الصوت:</label>
                    <input type="url" id="audioPathUrl" value="background_music.mp3">
                </div>
            </div>
        </div>

        <div class="settings-actions">
            <button id="saveSettingsBtn"><i class="fas fa-save"></i> حفظ الإعدادات</button>
            <button id="resetGameBtn"><i class="fas fa-redo"></i> إعادة تعيين اللعبة للمستخدمين</button>
        </div>
    </div>
    <button id="muteToggleBtn"><i class="fas fa-volume-up"></i></button> <footer>
        <p>&copy; 2024 Voice Boom. جميع الحقوق محفوظة.</p>
    </footer>

    <audio id="backgroundMusic" loop></audio>
    <audio id="revealSound"></audio>


    <script>
        // المتغيرات العامة - تم جلبها من عناصر الـ HTML
        const usernameDisplay = document.getElementById('usernameDisplay');
        const playerCoinsDisplay = document.getElementById('playerCoinsDisplay');
        const luckyPointsDisplay = document.getElementById('luckyPointsDisplay');
        const gameMessage = document.getElementById('gameMessage');
        const gameContainer = document.getElementById('gameContainer');
        const autoPlayBtn = document.getElementById('autoPlayBtn');
        const tripleStrikeBtn = document.getElementById('tripleStrikeBtn');
        const hammerStrikeBtn = document.getElementById('hammerStrikeBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const roundsPlayedDisplay = document.getElementById('roundsPlayedDisplay');
        const toggleSettingsBtn = document.getElementById('toggleSettingsBtn'); // زر إظهار/إخفاء الإعدادات
        const settingsArea = document.getElementById('settingsArea'); // منطقة الإعدادات
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const muteToggleBtn = document.getElementById('muteToggleBtn');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const revealSound = document.getElementById('revealSound'); // صوت عند الكشف عن الصندوق

        let currentSettings = {}; // لتخزين الإعدادات الحالية من السيرفر
        let isMuted = false;

        // *** هذا هو السطر الحاسم: عنوان الـ Backend API الخاص بك على Render ***
        const API_BASE_URL = 'https://voiceboom-wlxp.onrender.com';

        // ----------------------------------------------------
        // وظائف الواجهة الأمامية (UI Functions)
        // ----------------------------------------------------

        function displayGameMessage(message, type = 'info') {
            gameMessage.textContent = message;
            // استخدام متغيرات CSS للألوان
            gameMessage.style.backgroundColor = type === 'error' ? 'var(--accent-color-1)' : (type === 'success' ? 'var(--accent-color-2)' : 'var(--secondary-color)');
            gameMessage.style.display = 'block';
        }

        function clearGameMessage() {
            gameMessage.textContent = '';
            gameMessage.style.display = 'none';
        }

        function updateUI(data) {
            usernameDisplay.textContent = `اللاعب: ${data.username || 'غير معروف'}`;
            playerCoinsDisplay.textContent = data.playerCoins || 0;
            luckyPointsDisplay.textContent = data.luckyPoints || 0;
            roundsPlayedDisplay.textContent = data.roundsPlayed || 0;

            // تحديث تكلفة الأزرار بناءً على الإعدادات الحالية
            if (currentSettings.autoPlayCost !== undefined) {
                document.getElementById('autoPlayCostDisplay').textContent = currentSettings.autoPlayCost;
            }
            if (currentSettings.tripleStrikeCost !== undefined) {
                document.getElementById('tripleStrikeCostDisplay').textContent = currentSettings.tripleStrikeCost;
            }
            if (currentSettings.hammerStrikeCost !== undefined) {
                document.getElementById('hammerStrikeCostDisplay').textContent = currentSettings.hammerStrikeCost;
            }

            updateButtonVisibility(); // تحديث حالة الأزرار بناءً على العملات
            updateActionButtonsState(); // تحديث حالة الأزرار بناءً على الإعدادات
        }

        function createGameBoxes(numBoxes) {
            gameContainer.innerHTML = '';
            for (let i = 0; i < numBoxes; i++) {
                const box = document.createElement('div');
                box.classList.add('game-box');
                box.dataset.index = i; // لتحديد الصندوق
                box.innerHTML = '<span class="content">?</span>'; // محتوى مبدئي مخفي
                gameContainer.appendChild(box);
            }
        }

        function updateBoxContent(boxElement, prizeValue, isNegative) {
            const contentSpan = boxElement.querySelector('.content');
            contentSpan.textContent = prizeValue > 0 ? `+${prizeValue}` : prizeValue;
            boxElement.classList.add('revealed');
            if (isNegative) {
                boxElement.classList.add('negative');
            }
            revealSound.currentTime = 0; // إعادة الصوت من البداية
            revealSound.play().catch(e => console.error("Error playing reveal sound:", e));
        }

        function updateButtonVisibility() {
            // منطق إظهار/إخفاء الأزرار بناءً على العملات أو حالة اللعبة
            // يمكن إضافة المزيد من المنطق هنا لاحقاً
        }

        function updateActionButtonsState() {
            const currentCoins = parseInt(playerCoinsDisplay.textContent);
            autoPlayBtn.disabled = currentCoins < currentSettings.autoPlayCost;
            tripleStrikeBtn.disabled = currentCoins < currentSettings.tripleStrikeCost;
            hammerStrikeBtn.disabled = currentCoins < currentSettings.hammerStrikeCost;
        }

        function toggleMute() {
            isMuted = !isMuted;
            backgroundMusic.muted = isMuted;
            revealSound.muted = isMuted;
            muteToggleBtn.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
            // حفظ حالة الكتم في Local Storage
            localStorage.setItem('isMuted', isMuted);
        }

        // ----------------------------------------------------
        // وظائف الاتصال بـ API (API Calls)
        // ----------------------------------------------------

        async function fetchUserDataAndSettings() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log("No token found, redirecting to index.html");
                window.location.href = 'index.html'; // إعادة توجيه إذا لم يكن هناك رمز
                return;
            }

            try {
                // جلب بيانات المستخدم
                const userResponse = await fetch(`${API_BASE_URL}/api/user/data`, { // تم التعديل
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const userData = await userResponse.json();

                // جلب إعدادات اللعبة
                const settingsResponse = await fetch(`${API_BASE_URL}/api/admin/settings`, { // تم التعديل
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const settingsData = await settingsResponse.json();

                if (userResponse.ok && settingsResponse.ok) {
                    const isAdmin = userData.isAdmin;
                    updateUI(userData); // تحديث العملات والنقاط

                    // تحديث الإعدادات في الواجهة
                    currentSettings = settingsData.settings; // تخزين الإعدادات المستلمة
                    populateSettingsForm(currentSettings); // ملء نموذج الإعدادات

                    // تطبيق إعدادات التصميم (الخلفية والصوت)
                    applyDesignSettings(currentSettings);

                    createGameBoxes(currentSettings.numBoxes || 10); // إنشاء الصناديق بناءً على الإعدادات

                    // إظهار زر الإعدادات للمشرف فقط
                    if (isAdmin) {
                        toggleSettingsBtn.style.display = 'block';
                        settingsArea.style.display = 'none'; // تأكد أنها مخفية في البداية
                        toggleSettingsBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
                    } else {
                        toggleSettingsBtn.style.display = 'none';
                        settingsArea.style.display = 'none';
                    }
                    displayGameMessage('اضغط "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" للكشف عن النقاط!', 'info');


                    updateButtonVisibility();
                    updateActionButtonsState();

                } else {
                    // إذا كان هناك خطأ في أي من الطلبين
                    console.error('Failed to fetch user data or settings:', userData.message, settingsData.message);
                    displayGameMessage(userData.message || settingsData.message || 'فشل في جلب البيانات', 'error');
                    // إعادة توجيه فقط إذا كان الخطأ يدل على عدم المصادقة
                    if (userResponse.status === 401 || settingsResponse.status === 401) {
                         console.log("Authentication failed, redirecting to index.html");
                         window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('Error fetching user data or settings (network error/server down):', error);
                displayGameMessage('حدث خطأ في الاتصال بالخادم. تأكد من أن الخادم يعمل.', 'error');
                // في حالة وجود خطأ في الشبكة (مثلاً، الخادم لا يعمل)، يجب إعادة التوجيه
                console.log("Network error, redirecting to index.html");
                window.location.href = 'index.html';
            }
        }

        async function performGameAction(actionType) {
            const token = localStorage.getItem('token');
            if (!token) {
                displayGameMessage('الرجاء تسجيل الدخول أولاً.', 'error');
                console.log("No token found for game action, redirecting to index.html");
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/user/${actionType}`, { // تم التعديل
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (response.ok) {
                    updateUI(result); // تحديث واجهة المستخدم بالبيانات الجديدة

                    // تحديث الصناديق بعد الكشف
                    if (result.revealedBoxes && Array.isArray(result.revealedBoxes)) {
                        result.revealedBoxes.forEach(boxResult => {
                            const boxElement = document.querySelector(`.game-box[data-index="${boxResult.index}"]`);
                            if (boxElement) {
                                const isNegative = boxResult.prize < 0;
                                updateBoxContent(boxElement, boxResult.prize, isNegative);
                            }
                        });
                    }

                    displayGameMessage(result.message, 'success');
                } else {
                    displayGameMessage(result.message, 'error');
                     if (response.status === 401) { // إذا كان التوكن غير صالح
                        console.log("Token invalid for game action, redirecting to index.html");
                        localStorage.removeItem('token'); // مسح التوكن الفاسد
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error(`Error performing ${actionType}:`, error);
                displayGameMessage('حدث خطأ في الاتصال بالخادم.', 'error');
            } finally {
                // بعد أي حركة، أعد إنشاء الصناديق لبدء جولة جديدة
                // يمكنك تأخير هذه الخطوة قليلاً لإعطاء وقت للمستخدم لرؤية النتائج
                setTimeout(() => {
                    createGameBoxes(currentSettings.numBoxes || 10);
                    clearGameMessage();
                }, 2000); // إعادة إنشاء بعد 2 ثانية
            }
        }

        async function saveSettings() {
            const token = localStorage.getItem('token');
            if (!token) {
                displayGameMessage('الرجاء تسجيل الدخول كمسؤول لحفظ الإعدادات.', 'error');
                console.log("No token found for save settings, redirecting to index.html");
                window.location.href = 'index.html';
                return;
            }

            // جمع البيانات من النموذج
            const settingsToSave = {
                numBoxes: parseInt(document.getElementById('numBoxes').value),
                num10PointsBoxes: parseInt(document.getElementById('num10PointsBoxes').value),
                num5PointsBoxes: parseInt(document.getElementById('num5PointsBoxes').value),
                num1PointsBoxes: parseInt(document.getElementById('num1PointsBoxes').value),
                numNegative5PointsBoxes: parseInt(document.getElementById('numNegative5PointsBoxes').value),
                numNegative10PointsBoxes: parseInt(document.getElementById('numNegative10PointsBoxes').value),
                initialCoins: parseInt(document.getElementById('initialCoins').value),
                autoPlayCost: parseInt(document.getElementById('autoPlayCost').value),
                autoPlayMaxPrize: parseInt(document.getElementById('autoPlayMaxPrize').value),
                tripleStrikeCost: parseInt(document.getElementById('tripleStrikeCost').value),
                tripleStrikeMaxPrize: parseInt(document.getElementById('tripleStrikeMaxPrize').value),
                tripleStrikeLuckyChance: parseFloat(document.getElementById('tripleStrikeLuckyChance').value),
                tripleHitPoints: parseInt(document.getElementById('tripleHitPoints').value),
                hammerStrikeCost: parseInt(document.getElementById('hammerStrikeCost').value),
                hammerHitPoints: parseInt(document.getElementById('hammerHitPoints').value),
                backgroundImg: document.getElementById('backgroundImgUrl').value,
                audioPath: document.getElementById('audioPathUrl').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, { // تم التعديل
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(settingsToSave)
                });
                const result = await response.json();

                if (response.ok) {
                    displayGameMessage(result.message, 'success');
                    currentSettings = result.settings; // تحديث الإعدادات المحلية بعد الحفظ
                    applyDesignSettings(currentSettings); // تطبيق إعدادات التصميم الجديدة
                    updateUI(result.settings); // لتحديث تكاليف الأزرار إذا تغيرت
                    createGameBoxes(currentSettings.numBoxes || 10); // إعادة إنشاء الصناديق إذا تغير العدد
                } else {
                    displayGameMessage(result.message, 'error');
                    if (response.status === 401) { // إذا كان التوكن غير صالح
                        console.log("Token invalid for save settings, redirecting to index.html");
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                displayGameMessage('حدث خطأ في الاتصال بالخادم أثناء حفظ الإعدادات.', 'error');
            }
        }

        async function resetGameForUsers() {
            if (!confirm('هل أنت متأكد من إعادة تعيين اللعبة لجميع المستخدمين؟ هذا لا يمكن التراجع عنه!')) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                displayGameMessage('الرجاء تسجيل الدخول كمسؤول لإعادة تعيين اللعبة.', 'error');
                console.log("No token found for reset game, redirecting to index.html");
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/reset-game`, { // تم التعديل
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (response.ok) {
                    displayGameMessage(result.message, 'success');
                    // تحديث واجهة المستخدم بعد إعادة التعيين إذا كان المستخدم الحالي متأثرًا
                    fetchUserDataAndSettings();
                } else {
                    displayGameMessage(result.message, 'error');
                     if (response.status === 401) { // إذا كان التوكن غير صالح
                        console.log("Token invalid for reset game, redirecting to index.html");
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('Error resetting game:', error);
                displayGameMessage('حدث خطأ في الاتصال بالخادم أثناء إعادة تعيين اللعبة.', 'error');
            }
        }

        // وظيفة لملء حقول الإعدادات من البيانات المستلمة
        function populateSettingsForm(settings) {
            document.getElementById('numBoxes').value = settings.numBoxes || '';
            document.getElementById('num10PointsBoxes').value = settings.num10PointsBoxes || '';
            document.getElementById('num5PointsBoxes').value = settings.num5PointsBoxes || '';
            document.getElementById('num1PointsBoxes').value = settings.num1PointsBoxes || '';
            document.getElementById('numNegative5PointsBoxes').value = settings.numNegative5PointsBoxes || '';
            document.getElementById('numNegative10PointsBoxes').value = settings.numNegative10PointsBoxes || '';
            document.getElementById('initialCoins').value = settings.initialCoins || '';
            document.getElementById('autoPlayCost').value = settings.autoPlayCost || '';
            document.getElementById('autoPlayMaxPrize').value = settings.autoPlayMaxPrize || '';
            document.getElementById('tripleStrikeCost').value = settings.tripleStrikeCost || '';
            document.getElementById('tripleStrikeMaxPrize').value = settings.tripleStrikeMaxPrize || '';
            document.getElementById('tripleStrikeLuckyChance').value = settings.tripleStrikeLuckyChance || '';
            document.getElementById('tripleHitPoints').value = settings.tripleHitPoints || '';
            document.getElementById('hammerStrikeCost').value = settings.hammerStrikeCost || '';
            document.getElementById('hammerHitPoints').value = settings.hammerHitPoints || '';
            document.getElementById('backgroundImgUrl').value = settings.backgroundImg || 'default_background.jpg'; // قيمة افتراضية في الواجهة
            document.getElementById('audioPathUrl').value = settings.audioPath || 'background_music.mp3'; // قيمة افتراضية في الواجهة
        }

        // وظيفة لتطبيق إعدادات التصميم (الخلفية والصوت)
        function applyDesignSettings(settings) {
            // تطبيق صورة الخلفية
            if (settings.backgroundImg) {
                document.body.style.backgroundImage = `url('${settings.backgroundImg}')`;
            } else {
                // إذا لم تكن هناك صورة محددة، استخدم الصورة الافتراضية في CSS
                document.body.style.backgroundImage = `url('default_background.jpg')`;
            }

            // تطبيق صوت الخلفية
            if (settings.audioPath) {
                backgroundMusic.src = settings.audioPath;
                // محاولة تشغيل الصوت فوراً، مع التعامل مع قيود المتصفح
                if (!isMuted) { // تشغيل الصوت فقط إذا لم يتم كتمه يدوياً
                    backgroundMusic.play().catch(e => {
                        console.warn("User interaction required to play background music:", e);
                        // يمكن هنا إظهار زر "تشغيل الصوت" للمستخدم إذا لم يتم التشغيل تلقائياً
                    });
                }
            } else {
                backgroundMusic.pause();
                backgroundMusic.src = ''; // مسح المصدر إذا لم يكن هناك مسار
            }
        }


        // ----------------------------------------------------
        // ربط الأحداث (Event Listeners)
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            fetchUserDataAndSettings(); // جلب البيانات والإعدادات عند تحميل الصفحة

            // استعادة حالة الكتم من Local Storage
            const savedMuteState = localStorage.getItem('isMuted');
            if (savedMuteState !== null) {
                isMuted = JSON.parse(savedMuteState);
                toggleMute(); // تطبيق الحالة المستعادة (سيقوم بتحديث الأيقونة وكتم الصوت)
            } else {
                // محاولة تشغيل الصوت لأول مرة إذا لم يتم حفظ حالة الكتم
                // هذا قد لا يعمل في بعض المتصفحات بدون تفاعل المستخدم
                backgroundMusic.play().catch(e => console.warn("Initial background music play error, user interaction may be required:", e));
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        });

        gameContainer.addEventListener('click', (event) => {
            // إذا كان المستخدم لا يزال قادراً على النقر على الصناديق الفردية
            // هنا ستكون منطقتك لمعالجة النقر على الصندوق إذا كانت اللعبة تسمح بذلك
            // حالياً، اللعبة تعتمد على الأزرار (تلقائي، ثلاثي، مطرقة)
            // لذا، لن يتم معالجة النقر الفردي على الصناديق إلا إذا أضفت منطق لذلك
            if (event.target.classList.contains('game-box') && !event.target.classList.contains('revealed')) {
                // يمكنك هنا إضافة استدعاء لـ performGameAction مع نوع حركة "single-click" مثلاً
                // أو أي منطق آخر لفتح صندوق واحد إذا سمحت بذلك قواعد اللعبة.
                // حالياً، لا يوجد مسار API لـ "single-click" في الـ Backend الذي ناقشناه.
                console.log("Box clicked:", event.target.dataset.index);
                // displayGameMessage("هذا الصندوق تم كشفه تلقائياً أو عبر إجراء خاص. اضغط زر اللعب.", "info");
            }
        });


        autoPlayBtn.addEventListener('click', () => performGameAction('auto-play'));
        tripleStrikeBtn.addEventListener('click', () => performGameAction('triple-strike'));
        hammerStrikeBtn.addEventListener('click', () => performGameAction('hammer-strike'));

        // زر إظهار/إخفاء الإعدادات تم ربطه بالفعل في fetchUserDataAndSettings
        toggleSettingsBtn.addEventListener('click', () => {
            if (settingsArea.style.display === 'none') {
                settingsArea.style.display = 'block';
                toggleSettingsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء الإعدادات';
            } else {
                settingsArea.style.display = 'none';
                toggleSettingsBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
            }
        });

        saveSettingsBtn.addEventListener('click', saveSettings);
        resetGameBtn.addEventListener('click', resetGameForUsers);
        muteToggleBtn.addEventListener('click', toggleMute);

        // إضافة صوت عند كشف الصندوق (مثال: يمكنك استخدام صوت نقرة أو صوت فتح صندوق)
        revealSound.src = 'reveal_sound.mp3'; // تأكد من وجود هذا الملف في مجلد الواجهة الأمامية
        revealSound.volume = 0.5; // ضبط مستوى الصوت
    </script>
</body>
</html>