<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Voice Boom</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-bg-color: #2c3e50; /* لون خلفية أساسي داكن */
            --secondary-color: #34495e; /* لون ثانوي أغمق قليلاً */
            --accent-color-1: #e74c3c; /* أحمر جذاب للأزرار أو الرسائل (مثل الأخطاء أو النقاط السالبة) */
            --accent-color-2: #2ecc71; /* أخضر للنجاح */
            --text-color-light: #ecf0f1; /* نص فاتح */
            --text-color-dark: #34495e; /* نص داكن */
            --border-color: #7f8c8d; /* لون الحدود */
            --box-bg-color: rgba(44, 62, 80, 0.8); /* خلفية الصندوق شبه شفافة */
            --button-bg-color: #2980b9; /* لون أزرق للأزرار */
            --button-hover-color: #3498db; /* لون أزرق أفتح عند المرور */
            --header-footer-bg: rgba(0, 0, 0, 0.6); /* خلفية رأس وتذييل شفافة */
            --message-info-bg: #3498db; /* رسائل معلومات */
            --message-success-bg: #2ecc71; /* رسائل نجاح */
            --message-error-bg: #e74c3c; /* رسائل خطأ */
        }

        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            color: var(--text-color-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            overflow-x: hidden;
            position: relative;
            z-index: 0;

            background-image: url('default_background.jpg'); /* تم تعديل اسم الملف */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: var(--primary-bg-color); /* لون احتياطي */
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5); /* طبقة تعتيم */
            z-index: -1;
        }

        header, footer {
            width: 100%;
            text-align: center;
            padding: 15px 0;
            background: var(--header-footer-bg);
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            box-sizing: border-box;
            flex-wrap: wrap; /* لتناسب الشاشات الصغيرة */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: #f39c12; /* لون ذهبي للعنوان */
            font-family: 'Amiri', serif;
            flex-grow: 1; /* للسماح للعنوان بالنمو */
            text-align: center; /* توسيط العنوان */
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center; /* توسيط العناصر عند الالتفاف */
        }

        .user-info span {
            font-size: 1.1em;
            color: var(--text-color-light);
        }

        .user-info .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #f39c12; /* لون ذهبي لاسم اللاعب */
        }

        .user-info .coins, .user-info .lucky-points, .user-info .rounds-played {
            background: var(--secondary-color);
            padding: 8px 12px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .user-info .lucky-points {
            color: #e67e22; /* لون برتقالي للنقاط المحظوظة */
        }

        .user-info .coins {
            color: #f1c40f; /* لون ذهبي للعملات */
        }
        
        .user-info .rounds-played {
            color: #bdc3c7; /* لون فضي للجولات */
        }

        .mute-button {
            background-color: var(--button-bg-color);
            color: var(--text-color-light);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .mute-button:hover {
            background-color: var(--button-hover-color);
        }

        main {
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            text-align: center;
            width: 100%;
            max-width: 900px; /* زيادة عرض المحتوى الرئيسي */
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* مرونة في عدد الأعمدة */
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 700px; /* عرض أقصى لشبكة الصناديق */
            justify-content: center;
            margin-top: 20px;
        }

        .box {
            width: 100px;
            height: 100px;
            background-color: var(--box-bg-color);
            border: 3px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent-color-1);
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            user-select: none; /* منع تحديد النص */
        }

        .box:hover:not(.revealed):not(.disabled) {
            transform: translateY(-5px);
            background-color: rgba(52, 73, 94, 0.9); /* أغمق قليلا عند التحويم */
        }

        .box.revealed {
            background-color: var(--accent-color-2);
            color: var(--text-color-dark);
            border-color: #27ae60;
            cursor: default;
            transform: scale(1.05); /* تكبير قليلاً عند الكشف */
        }
        
        .box.revealed.negative {
            background-color: var(--accent-color-1); /* أحمر للنقاط السالبة */
            color: var(--text-color-light);
            border-color: #c0392b;
        }

        .box.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .message-area {
            min-height: 60px;
            font-size: 1.2em;
            margin-bottom: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--message-info-bg);
            color: var(--text-color-light);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .message-area.success {
            background-color: var(--message-success-bg);
        }

        .message-area.error {
            background-color: var(--message-error-bg);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-button {
            background-color: var(--button-bg-color);
            color: var(--text-color-light);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .action-button:hover:not(:disabled) {
            background-color: var(--button-hover-color);
            transform: translateY(-2px);
        }

        .action-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .cost-display {
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 3px;
            margin-left: 8px;
            color: #f1c40f;
        }

        .game-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .game-buttons button {
            background-color: var(--accent-color-1);
            color: var(--text-color-light);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .game-buttons button:hover {
            background-color: #c0392b;
        }
        
        .settings-area {
            background: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            display: none; /* مخفية افتراضياً */
        }

        .settings-area h2 {
            color: #f39c12;
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Amiri', serif;
        }

        .settings-form label {
            display: block;
            margin-bottom: 8px;
            text-align: right;
            color: var(--text-color-light);
            font-size: 1.1em;
        }

        .settings-form input[type="number"],
        .settings-form input[type="checkbox"] {
            margin-bottom: 15px;
            width: calc(100% - 20px);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg-color);
            color: var(--text-color-light);
            font-size: 1em;
        }
        
        .settings-form input[type="checkbox"] {
            width: auto;
            margin-left: 10px;
            transform: scale(1.2);
        }

        .settings-form button {
            background-color: var(--accent-color-2);
            color: var(--text-color-light);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-top: 15px;
        }

        .settings-form button:hover {
            background-color: #27ae60;
        }
        
        .admin-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .admin-controls button {
            background-color: var(--button-bg-color);
            color: var(--text-color-light);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .admin-controls button:hover {
            background-color: var(--button-hover-color);
        }

        @media (max-width: 768px) {
            header, footer {
                flex-direction: column;
                gap: 15px;
            }

            header h1 {
                font-size: 2em;
            }

            .user-info {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            .user-info > div {
                width: 100%; /* اجعل كل عنصر معلومات يأخذ سطرًا كاملاً */
                text-align: center;
            }

            .boxes-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 10px;
            }

            .box {
                width: 80px;
                height: 80px;
                font-size: 1.5em;
            }

            .action-buttons, .game-buttons, .admin-controls {
                flex-direction: column;
                width: 100%;
            }

            .action-button, .game-buttons button, .admin-controls button, .settings-form button {
                width: 100%;
            }

            .settings-area {
                padding: 15px;
            }
            
            .mute-button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="user-info">
            <span class="player-name" id="playerName"></span>
            <span class="coins"><i class="fas fa-coins"></i> <span id="playerCoins">0</span></span>
            <span class="lucky-points"><i class="fas fa-star"></i> <span id="playerLuckyPoints">0</span></span>
            <span class="rounds-played"><i class="fas fa-redo"></i> <span id="playerRoundsPlayed">0</span></span>
        </div>
        <h1>Voice Boom</h1>
        <button id="logoutBtn" class="mute-button"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
    </header>

    <main>
        <div id="messageArea" class="message-area">اضغط "لعب" لبدء جولة جديدة!</div>
        
        <div class="game-area">
            <div id="boxesGrid" class="boxes-grid">
                </div>

            <div class="action-buttons">
                <button id="autoPlayBtn" class="action-button">
                    <i class="fas fa-robot"></i> لعب تلقائي <span class="cost-display" id="autoPlayCostDisplay">0</span>
                </button>
                <button id="tripleStrikeBtn" class="action-button">
                    <i class="fas fa-dice-three"></i> ضربة ثلاثية <span class="cost-display" id="tripleStrikeCostDisplay">0</span>
                </button>
                <button id="hammerStrikeBtn" class="action-button">
                    <i class="fas fa-hammer"></i> ضربة المطرقة <span class="cost-display" id="hammerStrikeCostDisplay">0</span>
                </button>
            </div>

            <div class="game-buttons">
                <button id="playButton">بدء جولة جديدة</button>
                <button id="collectPointsBtn" style="display: none;">جمع النقاط</button>
            </div>
        </div>

        <div id="settingsToggle" style="display: none;">
            <button id="toggleSettingsBtn" class="action-button"><i class="fas fa-cog"></i> إظهار الإعدادات</button>
        </div>

        <div id="settingsArea" class="settings-area">
            <h2>إعدادات اللعبة</h2>
            <form id="settingsForm" class="settings-form">
                <label for="numBoxesInput">عدد الصناديق:</label>
                <input type="number" id="numBoxesInput" min="1" max="20" value="5" required>

                <label for="minPrizeInput">الحد الأدنى للجائزة:</label>
                <input type="number" id="minPrizeInput" min="1" value="10" required>

                <label for="maxPrizeInput">الحد الأقصى للجائزة:</label>
                <input type="number" id="maxPrizeInput" min="10" value="100" required>
                
                <label for="freePlayToggle">لعب مجاني:</label>
                <input type="checkbox" id="freePlayToggle">

                <label for="playCostInput">تكلفة اللعب:</label>
                <input type="number" id="playCostInput" min="0" value="10" required>

                <label for="autoPlayCostInput">تكلفة اللعب التلقائي:</label>
                <input type="number" id="autoPlayCostInput" min="0" value="0" required>

                <label for="tripleStrikeCostInput">تكلفة الضربة الثلاثية:</label>
                <input type="number" id="tripleStrikeCostInput" min="0" value="0" required>

                <label for="hammerStrikeCostInput">تكلفة ضربة المطرقة:</label>
                <input type="number" id="hammerStrikeCostInput" min="0" value="0" required>

                <label for="resetGameCostInput">تكلفة إعادة تعيين اللعبة:</label>
                <input type="number" id="resetGameCostInput" min="0" value="0" required>

                <button type="submit" id="saveSettingsBtn">حفظ الإعدادات</button>
            </form>
        </div>

        <div id="adminControls" class="admin-controls" style="display: none;">
            <button id="resetGameBtn">إعادة تعيين اللعبة للمستخدمين</button>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Voice Boom Game. All rights reserved.</p>
        <button id="muteToggleBtn" class="mute-button"><i class="fas fa-volume-up"></i> كتم الصوت</button>
    </footer>

    <audio id="backgroundMusic" loop autoplay>
        <source src="background_music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <audio id="revealSound">
        <source src="reveal_sound.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        // تأكد من أن هذا الـ URL صحيح ويتوافق مع الـ Backend الخاص بك على Render
        const API_BASE_URL = 'https://voiceboom-wlxp.onrender.com';

        // Get DOM elements
        const playerNameSpan = document.getElementById('playerName');
        const playerCoinsSpan = document.getElementById('playerCoins');
        const playerLuckyPointsSpan = document.getElementById('playerLuckyPoints');
        const playerRoundsPlayedSpan = document.getElementById('playerRoundsPlayed');
        const boxesGrid = document.getElementById('boxesGrid');
        const messageArea = document.getElementById('messageArea');
        const playButton = document.getElementById('playButton');
        const collectPointsBtn = document.getElementById('collectPointsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const autoPlayBtn = document.getElementById('autoPlayBtn');
        const tripleStrikeBtn = document.getElementById('tripleStrikeBtn');
        const hammerStrikeBtn = document.getElementById('hammerStrikeBtn');
        const autoPlayCostDisplay = document.getElementById('autoPlayCostDisplay');
        const tripleStrikeCostDisplay = document.getElementById('tripleStrikeCostDisplay');
        const hammerStrikeCostDisplay = document.getElementById('hammerStrikeCostDisplay');
        const settingsToggleDiv = document.getElementById('settingsToggle');
        const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
        const settingsArea = document.getElementById('settingsArea');
        const settingsForm = document.getElementById('settingsForm');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const adminControlsDiv = document.getElementById('adminControls');
        const muteToggleBtn = document.getElementById('muteToggleBtn');

        // Settings input fields
        const numBoxesInput = document.getElementById('numBoxesInput');
        const minPrizeInput = document.getElementById('minPrizeInput');
        const maxPrizeInput = document.getElementById('maxPrizeInput');
        const freePlayToggle = document.getElementById('freePlayToggle');
        const playCostInput = document.getElementById('playCostInput');
        const autoPlayCostInput = document.getElementById('autoPlayCostInput');
        const tripleStrikeCostInput = document.getElementById('tripleStrikeCostInput');
        const hammerStrikeCostInput = document.getElementById('hammerStrikeCostInput');
        const resetGameCostInput = document.getElementById('resetGameCostInput');

        // Audio elements
        const backgroundMusic = document.getElementById('backgroundMusic');
        const revealSound = document.getElementById('revealSound');

        let currentRoundBoxes = [];
        let revealedBoxesCount = 0;
        let isGameActive = false; // Flag to control game state
        let userIsAdmin = false; // To store admin status
        let gameSettings = {}; // To store game settings
        let currentUserId = null; // To store the current user ID


        // --- Helper Functions ---

        function showMessage(msg, type = 'info') {
            messageArea.textContent = msg;
            messageArea.className = 'message-area'; // Reset classes
            messageArea.classList.add(type); // Add specific type class
        }

        function updateUI(userData) {
            playerNameSpan.textContent = userData.username;
            playerCoinsSpan.textContent = userData.playerCoins;
            playerLuckyPointsSpan.textContent = userData.luckyPoints;
            playerRoundsPlayedSpan.textContent = userData.roundsPlayed;
            
            // تحديث حالة الأزرار بناءً على العملات
            updateActionButtonsState();
        }

        function toggleMute() {
            if (backgroundMusic.muted) {
                backgroundMusic.muted = false;
                revealSound.muted = false;
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i> كتم الصوت';
            } else {
                backgroundMusic.muted = true;
                revealSound.muted = true;
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i> تفعيل الصوت';
            }
        }

        // --- Core Game Logic ---

        async function fetchUserDataAndSettings() {
            const token = localStorage.getItem('token');
            if (!token) {
                // If no token, redirect to login page
                window.location.href = 'index.html';
                return;
            }

            try {
                // Fetch user data
                const userDataResponse = await fetch(`${API_BASE_URL}/api/user/data`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (userDataResponse.ok) {
                    const userData = await userDataResponse.json();
                    updateUI(userData);
                    userIsAdmin = userData.isAdmin;
                    currentUserId = userData._id; // Store user ID
                    
                    // Show/hide admin controls and settings toggle
                    if (userIsAdmin) {
                        adminControlsDiv.style.display = 'flex';
                        settingsToggleDiv.style.display = 'block';
                    } else {
                        adminControlsDiv.style.display = 'none';
                        settingsToggleDiv.style.display = 'none';
                    }

                } else {
                    // Handle unauthorized or other errors for user data
                    const errorData = await userDataResponse.json();
                    console.error('Error fetching user data:', errorData.message);
                    showMessage(`فشل جلب بيانات المستخدم: ${errorData.message}`, 'error');
                    localStorage.removeItem('token'); // Invalidate token if fetch failed
                    window.location.href = 'index.html'; // Redirect to login
                    return; // Stop execution
                }

                // Fetch game settings (only if user data fetch was successful)
                const settingsResponse = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (settingsResponse.ok) {
                    const settingsData = await settingsResponse.json();
                    gameSettings = settingsData.value; // Store the 'value' object directly
                    populateSettingsForm(settingsData); // Pass the full settingsData to populate
                    updateActionButtonsState(); // Update button costs
                } else {
                    const errorData = await settingsResponse.json();
                    console.error('Error fetching settings:', errorData.message);
                    showMessage(`فشل جلب إعدادات اللعبة: ${errorData.message}`, 'error');
                    // Continue without settings if not critical, or redirect if it is
                }

            } catch (error) {
                console.error('Error fetching user data or settings (network error/server down):', error);
                showMessage('خطأ في جلب البيانات أو الإعدادات (مشكلة في الشبكة/الخادم).', 'error');
                // Consider redirecting to login or showing a specific error page
            }
        }

        // Helper to update action button costs
        function updateActionButtonsState() {
            // تحديث تكاليف الأزرار بناءً على الإعدادات المستلمة
            autoPlayCostDisplay.textContent = gameSettings.autoPlayCost || 0; // افتراضي 0 إذا لم يكن موجودا
            tripleStrikeCostDisplay.textContent = gameSettings.tripleStrikeCost || 0;
            hammerStrikeCostDisplay.textContent = gameSettings.hammerStrikeCost || 0;

            const playerCoins = parseInt(playerCoinsSpan.textContent);

            autoPlayBtn.disabled = playerCoins < (gameSettings.autoPlayCost || 0) || !isGameActive;
            tripleStrikeBtn.disabled = playerCoins < (gameSettings.tripleStrikeCost || 0) || !isGameActive;
            hammerStrikeBtn.disabled = playerCoins < (gameSettings.hammerStrikeCost || 0) || !isGameActive;
            
            // زر اللعب الجديد
            playButton.textContent = isGameActive ? `لعب (${gameSettings.playCost} قطعة)` : `بدء جولة جديدة`;
            playButton.disabled = isGameActive ? (playerCoins < (gameSettings.playCost || 0) && !gameSettings.freePlay) : false;

            collectPointsBtn.style.display = isGameActive ? 'block' : 'none';
        }

        function createBoxes(num) {
            boxesGrid.innerHTML = ''; // Clear existing boxes
            currentRoundBoxes = [];
            revealedBoxesCount = 0;
            for (let i = 0; i < num; i++) {
                const box = document.createElement('div');
                box.classList.add('box');
                box.dataset.index = i; // Store index for identification
                box.textContent = '?'; // Initial state
                box.addEventListener('click', () => revealBox(i));
                boxesGrid.appendChild(box);
                currentRoundBoxes.push({ element: box, value: 0, isRevealed: false });
            }
        }

        async function revealBox(index, isSpecialAction = false) {
            if (!isGameActive || currentRoundBoxes[index].isRevealed) {
                return; // Do nothing if game is not active or box is already revealed
            }

            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('الرجاء تسجيل الدخول.', 'error');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/reveal-box`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ boxIndex: index, isSpecialAction })
                });

                const data = await response.json();

                if (response.ok) {
                    const box = currentRoundBoxes[index].element;
                    const value = data.pointsRevealed;
                    box.textContent = value;
                    box.classList.remove('active'); // Remove active class if any
                    box.classList.add('revealed');
                    if (value < 0) {
                        box.classList.add('negative');
                    } else {
                        box.classList.remove('negative');
                    }
                    currentRoundBoxes[index].isRevealed = true;
                    currentRoundBoxes[index].value = value; // Store the revealed value
                    revealedBoxesCount++;

                    updateUI(data.userData); // Update player coins and points
                    showMessage(data.message, 'info'); // Show message from backend

                    // Play reveal sound
                    if (!revealSound.muted) {
                        revealSound.currentTime = 0; // Reset sound to play from start
                        revealSound.play().catch(e => console.error("Reveal sound play error:", e));
                    }
                    
                    // Check if all boxes are revealed or other game end condition
                    if (revealedBoxesCount === currentRoundBoxes.length) {
                        showMessage('جميع الصناديق تم كشفها! اضغط "جمع النقاط" لإنهاء الجولة.', 'info');
                        // Optionally disable play button and enable collect here if not already handled
                    }
                    updateButtonVisibility();

                } else {
                    showMessage(data.message || 'حدث خطأ أثناء كشف الصندوق.', 'error');
                    // If unauthorized, redirect to login
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('Network error during box reveal:', error);
                showMessage('خطأ في الشبكة أثناء كشف الصندوق.', 'error');
            }
        }

        async function startNewRound() {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('الرجاء تسجيل الدخول.', 'error');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/start-round`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    isGameActive = true;
                    revealedBoxesCount = 0; // Reset revealed count for new round
                    updateUI(data.userData); // Update player data
                    createBoxes(gameSettings.numBoxes); // Create boxes based on settings
                    showMessage('بدأت جولة جديدة! اختر صندوقاً للكشف عنه.', 'success');
                    updateButtonVisibility(); // Update button states
                    updateActionButtonsState(); // Update action buttons (costs and disabled state)

                } else {
                    showMessage(data.message || 'فشل بدء جولة جديدة.', 'error');
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('Network error during start round:', error);
                showMessage('خطأ في الشبكة أثناء بدء الجولة.', 'error');
            }
        }
        
        async function collectPoints() {
            if (!isGameActive) return;

            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('الرجاء تسجيل الدخول.', 'error');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/collect-points`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    isGameActive = false;
                    updateUI(data.userData); // Update with final points
                    showMessage(data.message, 'success');
                    updateButtonVisibility(); // Update button states (disable collect, enable play)
                    updateActionButtonsState(); // Update action buttons after round end
                    currentRoundBoxes.forEach(box => {
                        box.element.removeEventListener('click', () => revealBox(box.dataset.index));
                        box.element.classList.add('disabled'); // Disable clicking after round ends
                    });

                } else {
                    showMessage(data.message || 'فشل جمع النقاط.', 'error');
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('Network error during collect points:', error);
                showMessage('خطأ في الشبكة أثناء جمع النقاط.', 'error');
            }
        }

        async function performGameAction(actionType) {
            if (!isGameActive) {
                showMessage('يرجى بدء جولة جديدة أولاً.', 'info');
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('الرجاء تسجيل الدخول.', 'error');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ actionType })
                });

                const data = await response.json();

                if (response.ok) {
                    updateUI(data.userData);
                    showMessage(data.message, 'success');

                    if (data.revealedBoxes && Array.isArray(data.revealedBoxes)) {
                        data.revealedBoxes.forEach(revealed => {
                            const boxIndex = revealed.boxIndex;
                            const value = revealed.value;
                            if (currentRoundBoxes[boxIndex]) {
                                const box = currentRoundBoxes[boxIndex].element;
                                box.textContent = value;
                                box.classList.remove('active');
                                box.classList.add('revealed');
                                if (value < 0) {
                                    box.classList.add('negative');
                                } else {
                                    box.classList.remove('negative');
                                }
                                currentRoundBoxes[boxIndex].isRevealed = true;
                                currentRoundBoxes[boxIndex].value = value;
                                revealedBoxesCount++;
                                
                                if (!revealSound.muted) {
                                    revealSound.currentTime = 0;
                                    revealSound.play().catch(e => console.error("Reveal sound play error:", e));
                                }
                            }
                        });
                    }
                    updateButtonVisibility();
                    updateActionButtonsState(); // Update action buttons after cost deduction

                } else {
                    showMessage(data.message || `فشل إجراء ${actionType}.`, 'error');
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error(`Network error during ${actionType} action:`, error);
                showMessage(`خطأ في الشبكة أثناء إجراء ${actionType}.`, 'error');
            }
        }

        function updateButtonVisibility() {
            playButton.style.display = isGameActive ? 'none' : 'block';
            collectPointsBtn.style.display = isGameActive ? 'block' : 'none';
        }
        
        // --- Admin Functions ---

        /**
         * Populates the settings form with data fetched from the backend.
         * @param {object} settingsData - The settings object received from the backend,
         * expected to have a 'value' property containing the actual settings.
         */
        function populateSettingsForm(settingsData) {
            // Ensure settingsData and its 'value' property exist
            if (settingsData && settingsData.value) {
                numBoxesInput.value = settingsData.value.numBoxes || 5; // Default if undefined
                minPrizeInput.value = settingsData.value.minPrize || 10;
                maxPrizeInput.value = settingsData.value.maxPrize || 100;
                freePlayToggle.checked = settingsData.value.freePlay || false;
                playCostInput.value = settingsData.value.playCost || 10;
                
                // Assuming these costs are also part of settingsData.value
                autoPlayCostInput.value = settingsData.value.autoPlayCost || 0;
                tripleStrikeCostInput.value = settingsData.value.tripleStrikeCost || 0;
                hammerStrikeCostInput.value = settingsData.value.hammerStrikeCost || 0;
                resetGameCostInput.value = settingsData.value.resetGameCost || 0;
            } else {
                console.error("Error: settingsData or settingsData.value is undefined. Cannot populate form.");
                showMessage("فشل تحميل إعدادات اللعبة. الرجاء المحاولة لاحقاً.", "error");
                // Optionally reset form to default values or disable it
            }
        }

        async function saveSettings() {
            const token = localStorage.getItem('token');
            if (!token || !userIsAdmin) {
                showMessage('ليس لديك صلاحية لحفظ الإعدادات.', 'error');
                window.location.href = 'index.html';
                return;
            }

            const updatedSettings = {
                name: 'gameConfig', // اسم الإعدادات الثابت في قاعدة البيانات
                value: { // يجب أن يكون كائن 'value' مطابقاً للـ Schema في Setting.js
                    numBoxes: parseInt(numBoxesInput.value),
                    minPrize: parseInt(minPrizeInput.value),
                    maxPrize: parseInt(maxPrizeInput.value),
                    freePlay: freePlayToggle.checked,
                    playCost: parseInt(playCostInput.value),
                    autoPlayCost: parseInt(autoPlayCostInput.value),
                    tripleStrikeCost: parseInt(tripleStrikeCostInput.value),
                    hammerStrikeCost: parseInt(hammerStrikeCostInput.value),
                    resetGameCost: parseInt(resetGameCostInput.value),
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updatedSettings)
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('تم حفظ الإعدادات بنجاح!', 'success');
                    gameSettings = updatedSettings.value; // Update local settings
                    updateActionButtonsState(); // Update UI with new costs
                } else {
                    showMessage(data.message || 'فشل حفظ الإعدادات.', 'error');
                }
            } catch (error) {
                console.error('Network error during saving settings:', error);
                showMessage('خطأ في الشبكة أثناء حفظ الإعدادات.', 'error');
            }
        }

        async function resetGameForUsers() {
            const token = localStorage.getItem('token');
            if (!token || !userIsAdmin) {
                showMessage('ليس لديك صلاحية لإعادة تعيين اللعبة.', 'error');
                return;
            }
            
            if (!confirm('هل أنت متأكد أنك تريد إعادة تعيين اللعبة لجميع المستخدمين؟ هذا سيؤثر على عملاتهم ونقاطهم!')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/reset-game`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message, 'success');
                    // optionally refetch user data after reset to reflect changes
                    fetchUserDataAndSettings(); 
                } else {
                    showMessage(data.message || 'فشل إعادة تعيين اللعبة.', 'error');
                }
            } catch (error) {
                console.error('Network error during game reset:', error);
                showMessage('خطأ في الشبكة أثناء إعادة تعيين اللعبة.', 'error');
            }
        }

        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserDataAndSettings(); // Fetch data on page load

            // Play background music
            backgroundMusic.volume = 0.3; // Set initial volume
            backgroundMusic.play().catch(e => console.error("Background music play error:", e));
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        });

        playButton.addEventListener('click', startNewRound);
        collectPointsBtn.addEventListener('click', collectPoints);

        autoPlayBtn.addEventListener('click', () => performGameAction('auto-play'));
        tripleStrikeBtn.addEventListener('click', () => performGameAction('triple-strike'));
        hammerStrikeBtn.addEventListener('click', () => performGameAction('hammer-strike'));

        // زر إظهار/إخفاء الإعدادات
        toggleSettingsBtn.addEventListener('click', () => {
            if (settingsArea.style.display === 'none') {
                settingsArea.style.display = 'block';
                toggleSettingsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء الإعدادات';
            } else {
                settingsArea.style.display = 'none';
                toggleSettingsBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
            }
        });

        saveSettingsBtn.addEventListener('click', saveSettings);
        resetGameBtn.addEventListener('click', resetGameForUsers);
        muteToggleBtn.addEventListener('click', toggleMute);

        // إضافة صوت عند كشف الصندوق
        revealSound.src = 'reveal_sound.mp3'; // تأكد من وجود هذا الملف في مجلد الواجهة الأمامية
        revealSound.volume = 0.7; // Set volume for reveal sound

    </script>
</body>
</html>