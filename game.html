<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Voice Boom</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            overflow-x: hidden;
            position: relative;
            z-index: 0;

            background-image: url('background_image.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .header-container {
            display: flex;
            justify-content: space-between; /* للحفاظ على المساحة بين العناصر */
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            position: relative; /* لتمكين وضع العناصر الفرعية بشكل مطلق إذا لزم الأمر */
        }

        .top-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1; /* للسماح لها بأخذ المساحة المتاحة ودفع العناصر الأخرى */
        }

        /* حاوية جديدة للشعار والعنوان لتوسيطهما */
        .centered-header-content {
            position: absolute; /* وضع مطلق لتوسيطها بغض النظر عن العناصر الأخرى */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1; /* تأكد أنها فوق عناصر أخرى إذا تداخلت */
        }

        .logo {
            width: 70px; /* زيادة حجم الشعار */
            height: 70px; /* زيادة حجم الشعار */
            border-radius: 50%;
            border: 2px solid #3498db;
            object-fit: cover;
        }

        .game-title {
            font-family: 'Amiri', serif;
            font-size: 3em; /* زيادة حجم الخط لاسم اللعبة */
            color: #3498db;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
            margin: 0;
        }
        
        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.8; }
        }


        .player-info {
            font-size: 1.1em;
            color: #E0E0E0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-info i {
            color: #27ae60;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-button-group {
            display: flex;
            gap: 10px;
        }

        .action-button,
        .settings-toggle-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-button:hover,
        .settings-toggle-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .action-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }

        /* تعديل الأزرار لتكون في صف واحد */
        .game-container .action-buttons-group {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px; /* مسافة بين الأزرار */
            flex-wrap: wrap; /* للسماح للأزرار بالانتقال إلى سطر جديد إذا كان هناك الكثير منها */
        }

        #autoPlayButton {
            background-color: #28a745; /* لون أخضر */
        }
        #autoPlayButton:hover {
            background-color: #218838;
        }

        #tripleShotButton {
            background-color: #e67e22; /* لون برتقالي */
            /* ليس هناك حاجة لـ order أو margin-left هنا بعد تجميعها في .action-buttons-group */
        }
        #tripleShotButton:hover {
            background-color: #d35400;
        }

        #hammerShotButton { /* ستايل زر ضربة المطرقة */
            background-color: #6C757D; /* لون رمادي */
        }
        #hammerShotButton:hover {
            background-color: #5A6268;
        }

        .game-container {
            background-color: rgba(44, 62, 80, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            text-align: center;
            width: 100%;
            max-width: 1200px;
            margin-top: 20px;
            position: relative;
        }

        .messages-area {
            min-height: 50px; /* زيادة الطول قليلاً لاستيعاب الخط الأكبر */
            margin-bottom: 20px;
            padding: 10px 15px; 
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.6); 
            /* تم تغيير حجم الخط هنا */
            font-size: 1.8em; /* زيادة حجم الخط ليكون أضخم */
            font-weight: bold;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8); /* زيادة وضوح الظل */
            
            /* خصائص ثابتة وموسّطة للنص */
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* توهج افتراضي (يمكن تغييره بالجافاسكريبت) */
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.7);
            transition: box-shadow 0.3s ease-in-out; /* حركة سلسة للتوهج */
            color: #e0e0e0; /* لون النص الافتراضي */
        }
        
        /* تأثيرات التوهج المخصصة */
        .messages-area.win-glow {
            box-shadow: 0 0 25px 10px rgba(40, 167, 69, 0.9), 
                        0 0 40px 15px rgba(40, 167, 69, 0.7); /* أخضر قوي */
            color: #d4edda; /* لون نص فاتح قليلاً ليتناسب مع الخلفية الخضراء */
        }

        .messages-area.lose-glow {
            box-shadow: 0 0 25px 10px rgba(220, 53, 69, 0.9), 
                        0 0 40px 15px rgba(220, 53, 69, 0.7); /* أحمر قوي */
            color: #f8d7da; /* لون نص فاتح قليلاً ليتناسب مع الخلفية الحمراء */
        }

        /* لوحة النتائج */
        .score-board-in-main {
            background-color: rgba(52, 152, 219, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px; /* مسافة عن الصناديق */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            font-size: 1.1em;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .score-board-in-main .score-item {
            font-weight: bold;
            color: #ECF0F1;
        }

        .score-board-in-main .score-item span {
            color: #2C3E50;
            /* تصغير حجم خط نقاط اللاعب */
            font-size: 0.9em; 
        }

        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .box {
            background-color: #2A9D8F;
            height: 150px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.3s ease, border 0.3s ease, background-color 0.3s ease, opacity 0.5s ease; /* إضافة opacity للانتقال */
            border: 2px solid #333333;
            color: #FFFFFF;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            position: relative;
            overflow: hidden;
            
            animation: floatAndGlow 4s infinite ease-in-out;
            box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
        }

        .box .box-image {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            margin-bottom: 5px;
        }
        
        .box .box-text {
            font-size: 1.1em;
        }

        @keyframes floatAndGlow {
            0% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
            }
            25% { 
                transform: translateY(-8px) scale(1.03); 
                box-shadow: 0 0 20px 8px var(--glow-color, rgba(68, 68, 68, 0.7)); 
            }
            50% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
            }
            75% { 
                transform: translateY(8px) scale(1.03); 
                box-shadow: 0 0 20px 8px var(--glow-color, rgba(68, 68, 68, 0.7)); 
            }
            100% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
            }
        }
        
        /* تأثير التوهج الأخضر للصندوق المحدد بواسطة التلقائي */
        .box.auto-glow {
            animation: none !important; /* إيقاف حركة floatAndGlow الأصلية */
            box-shadow: 0 0 25px 10px rgba(0, 255, 0, 0.8), 
                        0 0 40px 15px rgba(0, 255, 0, 0.6) !important; /* توهج أخضر ساطع */
            border-color: #00FF00 !important;
            transform: scale(1.05); /* تكبير بسيط للصندوق المحدد */
        }
        /* تأثير التوهج البرتقالي لصناديق الضربة الثلاثية */
        .box.triple-shot-glow {
            animation: none !important; 
            box-shadow: 0 0 25px 10px rgba(255, 165, 0, 0.8), 
                        0 0 40px 15px rgba(255, 165, 0, 0.6) !important; /* توهج برتقالي ساطع */
            border-color: #FFA500 !important;
            transform: scale(1.05);
        }
        /* تأثير التوهج الرمادي لضربة المطرقة */
        .box.hammer-shot-glow {
            animation: none !important; 
            box-shadow: 0 0 25px 10px rgba(108, 117, 125, 0.8), 
                        0 0 40px 15px rgba(108, 117, 125, 0.6) !important; /* توهج رمادي ساطع */
            border-color: #6C757D !important;
            transform: scale(1.05);
        }


        .box:hover:not(.opened) {
            transform: translateY(-12px) scale(1.07);
            animation: none;
            box-shadow: 0 0 30px 12px var(--glow-color, rgba(255, 255, 255, 0.9)) !important; 
        }

        .box.opened {
            cursor: default;
            animation: none !important;
            box-shadow: 0 0 20px 8px rgba(0, 0, 0, 0.8) !important;
            font-size: 3em;
            /* للتأكد من أن النص يظهر بشكل جيد */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .box.opened .box-image,
        .box.opened .box-text {
            display: none;
        }

        .box.opened.positive-score-10 {
            background-color: #3498DB;
            border: 2px solid #2980B9;
            color: #ECF0F1;
            font-weight: bold;
        }

        .box.opened.positive-score-5 {
            background-color: #9B59B6;
            border: 2px solid #8E44AD;
            color: #ECF0F1;
            font-weight: bold;
        }

        .box.opened.positive-score-1 {
            background-color: #DC143C;
            border: 2px solid #A52A2A;
            color: #ECF0F1;
            font-weight: bold;
        }

        .box.opened.negative-score-5 {
            background-color: #F39C12;
            border: 2px solid #E67E22;
            color: #2C3E50;
            font-weight: bold;
        }

        .box.opened.negative-score-10 {
            background-color: #E74C3C;
            border: 2px solid #C0392B;
            color: #ECF0F1;
            font-weight: bold;
        }
        
        .settings-area {
            background-color: rgba(44, 62, 80, 0.95);
            padding: 25px;
            border-radius: 10px;
            margin-top: 25px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
            display: none;
            text-align: right;
            width: 100%;
            max-width: 500px;
        }

        .settings-area h3 {
            color: #3498db;
            margin-bottom: 20px;
            font-family: 'Amiri', serif;
            font-size: 1.8em;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .form-group label {
            font-size: 1em;
            color: #ECF0F1;
            margin-bottom: 5px;
        }

        .form-group input[type="number"] {
            width: 100%;
            max-width: 250px;
            padding: 8px;
            border: 1px solid #3498db;
            border-radius: 5px;
            background-color: #34495e;
            color: #ECF0F1;
            font-size: 0.95em;
            text-align: right;
        }
        
        .form-group p {
            font-size: 0.9em;
            color: #bdc3c7;
            margin-top: -5px;
            text-align: right;
            width: 100%;
        }

        .settings-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .settings-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #27ae60;
        }

        .settings-buttons button.reset-button {
            background-color: #e74c3c;
        }

        .settings-buttons button:hover {
            background-color: #2ecc71;
        }

        .settings-buttons button.reset-button:hover {
            background-color: #c0392b;
        }

        .logout-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-button:hover {
            background-color: #c0392b;
        }

        .volume-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .volume-controls button {
            background-color: #7f8c8d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .volume-controls button:hover {
            background-color: #95a5a6;
        }

        #volumeSlider {
            width: 100px;
            -webkit-appearance: none;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 4px;
        }

        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        #volumeSlider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="top-left">
            </div>
        <div class="centered-header-content"> <img src="logo.png" alt="شعار اللعبة" class="logo">
            <h1 class="game-title">Voice Boom</h1>
        </div>
        <div class="top-right">
            <div class="player-info">
                <i class="fas fa-user-circle"></i>
                <span id="usernameDisplay">اللاعب</span>
            </div>
            <div class="settings-button-group">
                <button id="toggleBtn" class="settings-toggle-btn" style="display: none;">
                    <i class="fas fa-cog"></i> إظهار الإعدادات
                </button>
                <button id="logoutButton" class="logout-button">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
    </div>

    <div class="game-container">
        <div class="messages-area" id="messagesArea">
            </div>
        
        <div class="action-buttons-group">
            <button id="tripleShotButton" class="action-button">
                <i class="fas fa-bullseye"></i> ضربة ثلاثية (5 نقاط)
            </button>
            <button id="autoPlayButton" class="action-button">
                <i class="fas fa-magic"></i> تلقائي (2 نقاط)
            </button>
            <button id="hammerShotButton" class="action-button">
                <i class="fas fa-hammer"></i> ضربة المطرقة (20 نقطة)
            </button>
        </div>
        
        <div class="score-board-in-main" id="scoreBoardMain">
            <div class="score-item">الجولة: <span id="roundNumber">0</span></div>
            <div class="score-item">نقاط الجولة الحالية: <span id="currentRoundPoints">0</span></div>
            <div class="score-item">نقاطك الكلية: <span id="personalScore">0</span></div>
            <div class="score-item">أعلى النقاط: <span id="highScore">0</span></div>
        </div>

        <div id="boxesContainer" class="boxes-grid">
            </div>

        <div class="volume-controls">
            <button id="decreaseVolumeBtn"><i class="fas fa-volume-down"></i></button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
            <button id="increaseVolumeBtn"><i class="fas fa-volume-up"></i></button>
            <button id="muteToggleBtn"><i class="fas fa-volume-mute"></i></button>
        </div>

        <div id="settingsArea" class="settings-area">
            <h3>إعدادات اللعبة</h3>
            <div class="form-group">
                <label for="numBoxesInput">عدد الصناديق في الجولة:</label>
                <input type="number" id="numBoxesInput" min="5" max="100" value="10">
            </div>
            
            <div class="form-group">
                <label for="num10PointsBoxesInput">عدد الصناديق التي تضيف 10 نقاط:</label>
                <input type="number" id="num10PointsBoxesInput" min="0" value="1">
            </div>
            <div class="form-group">
                <label for="num5PointsBoxesInput">عدد الصناديق التي تضيف 5 نقاط:</label>
                <input type="number" id="num5PointsBoxesInput" min="0" value="2">
            </div>
            <div class="form-group">
                <label for="num1PointsBoxesInput">عدد الصناديق التي تضيف 1 نقطة:</label>
                <input type="number" id="num1PointsBoxesInput" min="0" value="3">
            </div>

            <div class="form-group">
                <label for="numNegative5PointsBoxesInput">عدد صناديق الضريبة (-5 نقاط):</label>
                <input type="number" id="numNegative5PointsBoxesInput" min="0" value="1">
            </div>
            <div class="form-group">
                <label for="numNegative10PointsBoxesInput">عدد صناديق الضريبة (-10 نقاط):</label>
                <input type="number" id="numNegative10PointsBoxesInput" min="0" value="0">
                <p>صناديق الضريبة ستخصم النقاط من رصيدك.</p>
            </div>
            <div class="settings-buttons">
                <button id="saveSettingsBtn"><i class="fas fa-save"></i> حفظ الإعدادات</button>
                <button id="resetGameBtn" class="reset-button"><i class="fas fa-redo"></i> إعادة تعيين اللعبة (للمشرف)</button>
            </div>
        </div>
    </div>

    <audio id="clickSound" src="click.mp3"></audio>
    <audio id="winSound" src="win.mp3"></audio>
    <audio id="loseSound" src="lose.mp3"></audio>
    <audio id="backgroundMusic" src="music.mp3" loop></audio>

    <script>
        // متغيرات عامة
        let username = '';
        let currentRoundPoints = 0;
        let boxes = [];
        let personalScore = 0;
        let highScore = 0;
        let roundNumber = 0;
        let numBoxes = 10;
        
        let num10PointsBoxes = 1;
        let num5PointsBoxes = 2;
        let num1PointsBoxes = 3;
        let numNegative5PointsBoxes = 1;
        let numNegative10PointsBoxes = 0;

        let isAdmin = false;
        let settings = {};
        let musicPlayedOnce = false;
        let autoPlayInterval = null; 
        let autoPlayIndex = 0; 

        // تكاليف استخدام الزر
        const AUTO_PLAY_COST = 2;
        const TRIPLE_SHOT_COST = 5;
        const HAMMER_SHOT_COST = 20; // تكلفة ضربة المطرقة
        const HAMMER_SHOT_BOXES = 15; // عدد الصناديق لضربة المطرقة

        const glowColors = [
            'rgba(52, 152, 219, 0.8)',
            'rgba(155, 89, 182, 0.8)',
            'rgba(220, 20, 60, 0.8)',
            'rgba(243, 156, 18, 0.8)',
            'rgba(231, 76, 60, 0.8)',
            'rgba(46, 204, 113, 0.8)',
            'rgba(241, 196, 15, 0.8)',
            'rgba(189, 195, 199, 0.8)'
        ];

        // عناصر HTML
        const usernameDisplay = document.getElementById('usernameDisplay');
        const messagesArea = document.getElementById('messagesArea');
        const autoPlayButton = document.getElementById('autoPlayButton'); 
        const tripleShotButton = document.getElementById('tripleShotButton'); 
        const hammerShotButton = document.getElementById('hammerShotButton'); // زر ضربة المطرقة
        const boxesContainer = document.getElementById('boxesContainer');
        const scoreBoardMain = document.getElementById('scoreBoardMain'); 
        const currentRoundPointsDisplay = document.getElementById('currentRoundPoints');
        const personalScoreDisplay = document.getElementById('personalScore');
        const highScoreDisplay = document.getElementById('highScore');
        const roundNumberDisplay = document.getElementById('roundNumber');
        const numBoxesInput = document.getElementById('numBoxesInput');
        
        const num10PointsBoxesInput = document.getElementById('num10PointsBoxesInput');
        const num5PointsBoxesInput = document.getElementById('num5PointsBoxesInput');
        const num1PointsBoxesInput = document.getElementById('num1PointsBoxesInput');
        const numNegative5PointsBoxesInput = document.getElementById('numNegative5PointsBoxesInput');
        const numNegative10PointsBoxesInput = document.getElementById('numNegative10PointsBoxesInput');

        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const clickSound = document.getElementById('clickSound');
        const winSound = document.getElementById('winSound');
        const loseSound = document.getElementById('loseSound');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const logoutButton = document.getElementById('logoutButton');
        const volumeSlider = document.getElementById('volumeSlider');
        const increaseVolumeBtn = document.getElementById('increaseVolumeBtn');
        const decreaseVolumeBtn = document.getElementById('decreaseVolumeBtn');
        const muteToggleBtn = document.getElementById('muteToggleBtn');
        const settingsArea = document.getElementById('settingsArea');
        const toggleBtn = document.getElementById('toggleBtn');

        // وظائف الصوت
        function setVolume(volume) {
            backgroundMusic.volume = volume;
            clickSound.volume = volume;
            winSound.volume = volume;
            loseSound.volume = volume;
        }

        function updateVolumeFromSlider() {
            setVolume(volumeSlider.value);
        }

        function increaseVolume() {
            volumeSlider.value = Math.min(parseFloat(volumeSlider.value) + 0.1, 1);
            updateVolumeFromSlider();
            muteToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            backgroundMusic.muted = false;
        }

        function decreaseVolume() {
            volumeSlider.value = Math.max(parseFloat(volumeSlider.value) - 0.1, 0);
            updateVolumeFromSlider();
            if (volumeSlider.value == 0) {
                 muteToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                 backgroundMusic.muted = true;
            }
        }

        function toggleMute() {
            if (backgroundMusic.muted) {
                backgroundMusic.muted = false;
                clickSound.muted = false;
                winSound.muted = false;
                loseSound.muted = false;
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                if (volumeSlider.value == 0) {
                    volumeSlider.value = 0.5;
                }
                setVolume(volumeSlider.value);
                if (!musicPlayedOnce) {
                    backgroundMusic.play().catch(e => console.error("Error playing music on mute toggle:", e));
                    musicPlayedOnce = true;
                }

            } else {
                backgroundMusic.muted = true;
                clickSound.muted = true;
                winSound.muted = true;
                loseSound.muted = true;
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            }
        }

        // وظيفة عرض الرسائل (معدلة لتغيير التوهج)
        function showMessage(msg, isError = false, isWin = false) {
            messagesArea.textContent = msg;
            
            // إزالة أي فئات توهج سابقة
            messagesArea.classList.remove('win-glow', 'lose-glow');

            // تطبيق توهج جديد بناءً على النتيجة
            if (isError) {
                messagesArea.classList.add('lose-glow');
            } else if (isWin) {
                messagesArea.classList.add('win-glow');
            } else {
                // إذا لم يكن هناك فوز أو خسارة، يمكننا تعيين توهج افتراضي أو لا شيء
                messagesArea.style.boxShadow = '0 0 15px rgba(52, 152, 219, 0.7)'; // توهج أزرق افتراضي
                messagesArea.style.color = '#e0e0e0'; // لون نص افتراضي
            }
        }

        // وظيفة تحديث عرض لوحة النتائج
        function updateScoreBoard() {
            currentRoundPointsDisplay.textContent = currentRoundPoints; // عرض النقاط الكلية بدلاً من نقاط الجولة الحالية
            personalScoreDisplay.textContent = personalScore;
            highScoreDisplay.textContent = highScore;
            roundNumberDisplay.textContent = roundNumber;
            updateActionButtonsState(); // تحديث حالة الأزرار بناءً على النقاط
        }

        // وظيفة لتحديث حالة أزرار "تلقائي" و "ضربة ثلاثية" و "ضربة المطرقة"
        function updateActionButtonsState() {
            if (personalScore < AUTO_PLAY_COST) {
                autoPlayButton.disabled = true;
                autoPlayButton.title = `تحتاج ${AUTO_PLAY_COST} نقاط لاستخدام "تلقائي"`;
            } else {
                autoPlayButton.disabled = false;
                autoPlayButton.title = '';
            }

            if (personalScore < TRIPLE_SHOT_COST) {
                tripleShotButton.disabled = true;
                tripleShotButton.title = `تحتاج ${TRIPLE_SHOT_COST} نقاط لاستخدام "ضربة ثلاثية"`;
            } else {
                tripleShotButton.disabled = false;
                tripleShotButton.title = '';
            }

            if (personalScore < HAMMER_SHOT_COST) {
                hammerShotButton.disabled = true;
                hammerShotButton.title = `تحتاج ${HAMMER_SHOT_COST} نقاط لاستخدام "ضربة المطرقة"`;
            } else {
                hammerShotButton.disabled = false;
                hammerShotButton.title = '';
            }
        }

        // وظيفة تحديث حالة أزرار المدير (حفظ / إعادة تعيين)
        function updateButtonVisibility() {
            if (isAdmin) {
                saveSettingsBtn.style.display = 'inline-block';
                resetGameBtn.style.display = 'inline-block';
            } else {
                saveSettingsBtn.style.display = 'none';
                resetGameBtn.style.display = 'none';
            }
        }

        // وظيفة إنشاء الصناديق
        function generateBoxes() {
            boxesContainer.innerHTML = '';
            boxes = [];
            
            let boxValues = [];

            for (let i = 0; i < num10PointsBoxes; i++) {
                boxValues.push({ type: 'positive', value: 10 });
            }
            for (let i = 0; i < num5PointsBoxes; i++) {
                boxValues.push({ type: 'positive', value: 5 });
            }
            for (let i = 0; i < num1PointsBoxes; i++) {
                boxValues.push({ type: 'positive', value: 1 });
            }

            for (let i = 0; i < numNegative5PointsBoxes; i++) {
                boxValues.push({ type: 'negative', value: -5 });
            }
            for (let i = 0; i < numNegative10PointsBoxes; i++) {
                boxValues.push({ type: 'negative', value: -10 });
            }

            const totalSpecifiedBoxes = boxValues.length;

            if (totalSpecifiedBoxes > numBoxes) {
                boxValues = boxValues.slice(0, numBoxes);
                showMessage(`تنبيه: مجموع الصناديق التي تم تحديدها (${totalSpecifiedBoxes}) يتجاوز العدد الكلي للصناديق (${numBoxes}). تم اختيار أول ${numBoxes} صندوق فقط.`, true);
            } else if (totalSpecifiedBoxes < numBoxes) {
                const remainingSlots = numBoxes - totalSpecifiedBoxes;
                // قم بملء الفراغات بصناديق +1 نقطة بشكل افتراضي
                for (let i = 0; i < remainingSlots; i++) {
                    boxValues.push({ type: 'positive', value: 1 });
                }
                showMessage(`تنبيه: تم ملء ${remainingSlots} صندوق إضافي بقيمة +1 نقطة لضمان العدد الكلي ${numBoxes}.`);
            }

            for (let i = boxValues.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [boxValues[i], boxValues[j]] = [boxValues[j], boxValues[i]];
            }

            for (let i = 0; i < numBoxes; i++) {
                const box = document.createElement('div');
                box.classList.add('box');
                box.dataset.index = i;
                box.dataset.type = boxValues[i].type; 
                box.dataset.value = boxValues[i].value;
                
                const randomGlowColor = glowColors[Math.floor(Math.random() * glowColors.length)];
                box.style.setProperty('--glow-color', randomGlowColor);

                const img = document.createElement('img');
                img.src = 'box_closed.png';
                img.alt = 'صندوق';
                img.classList.add('box-image');
                box.appendChild(img);
                
                boxesContainer.appendChild(box);
                boxes.push(box);
            }
        }

        // وظيفة فتح الصندوق (معدلة لإرجاع النقاط)
        function openBox(box) {
            if (box.classList.contains('opened')) {
                return 0; // إذا كان مفتوحًا بالفعل، أرجع 0
            }

            clickSound.play();

            box.classList.add('opened');
            
            const boxType = box.dataset.type; 
            const pointsValue = parseInt(box.dataset.value); 

            box.querySelector('.box-image').style.display = 'none';

            if (boxType === 'positive') {
                if (pointsValue === 10) {
                    box.classList.add('positive-score-10');
                } else if (pointsValue === 5) {
                    box.classList.add('positive-score-5');
                } else if (pointsValue === 1) {
                    box.classList.add('positive-score-1');
                }
                box.textContent = `+${pointsValue}`; 
                // لا نحدث currentRoundPoints ولا personalScore هنا، سنفعل ذلك في handleAutoPlay
                winSound.play();
            } else if (boxType === 'negative') {
                if (pointsValue === -5) {
                    box.classList.add('negative-score-5');
                } else if (pointsValue === -10) {
                    box.classList.add('negative-score-10');
                }
                box.textContent = `${pointsValue}`;
                // لا نحدث currentRoundPoints ولا personalScore هنا
                loseSound.play();
            }

            // المؤقت الجديد لإخفاء الصندوق بعد 10 ثوانٍ
            setTimeout(() => {
                box.style.opacity = '0'; // لجعلها تختفي بسلاسة
                box.style.pointerEvents = 'none'; // لمنع التفاعل معها بعد الإخفاء
                // إزالة الصندوق تمامًا بعد انتهاء الانتقال (0.5 ثانية)
                setTimeout(() => {
                    box.remove();
                    const remainingVisibleBoxes = boxes.filter(b => b.parentNode === boxesContainer).length; // تحقق من الصناديق التي لم تُزال بعد
                    if (remainingVisibleBoxes === 0) { 
                        endRound();
                    } else {
                        updateActionButtonsState();
                    }
                }, 500); // مدة الانتقال CSS
            }, 10000); // 10 ثوانٍ

            return pointsValue; // إرجاع قيمة النقاط
        }

        // وظيفة بدء جولة جديدة
        async function startNewRound() {
            autoPlayButton.disabled = true; 
            tripleShotButton.disabled = true;
            hammerShotButton.disabled = true; // تعطيل زر المطرقة أيضاً
            clearInterval(autoPlayInterval); 
            autoPlayIndex = 0; 
            boxes.forEach(box => {
                box.classList.remove('auto-glow');
                box.classList.remove('triple-shot-glow');
                box.classList.remove('hammer-shot-glow'); // إزالة توهج المطرقة
            });

            showMessage('جارٍ إعداد الجولة...');
            
            if (!musicPlayedOnce) {
                backgroundMusic.play().catch(e => console.error("Error playing music:", e));
                musicPlayedOnce = true;
            }

            try {
                // إرسال currentRoundPoints التي تم جمعها في الجولة السابقة
                const response = await fetch('/api/startRound', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, pointsEarnedInRound: currentRoundPoints })
                });
                const data = await response.json();

                if (response.ok) {
                    settings = data.settings;
                    personalScore = data.user.personalScore;
                    highScore = data.user.highScore;
                    roundNumber = data.user.roundNumber;
                    
                    numBoxes = settings.numBoxes;
                    num10PointsBoxes = settings.num10PointsBoxes;
                    num5PointsBoxes = settings.num5PointsBoxes;
                    num1PointsBoxes = settings.num1PointsBoxes;
                    numNegative5PointsBoxes = settings.numNegative5PointsBoxes;
                    numNegative10PointsBoxes = settings.numNegative10PointsBoxes;
                    
                    currentRoundPoints = 0; // إعادة تعيين نقاط الجولة الحالية
                    generateBoxes();
                    updateScoreBoard();
                    showMessage('اختر "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" للكشف عن النقاط!');
                    updateActionButtonsState(); 
                } else {
                    showMessage('خطأ في بدء الجولة: ' + data.message, true);
                    updateActionButtonsState(); 
                }
            } catch (error) {
                console.error('Error starting new round:', error);
                showMessage('حدث خطأ غير متوقع عند بدء الجولة.', true);
                updateActionButtonsState(); 
            }
        }

        // وظيفة إنهاء الجولة
        async function endRound() {
            autoPlayButton.disabled = true; 
            tripleShotButton.disabled = true;
            hammerShotButton.disabled = true; // تعطيل زر المطرقة أيضاً
            clearInterval(autoPlayInterval); 
            autoPlayIndex = 0; 

            boxes.forEach(box => {
                box.classList.remove('auto-glow');
                box.classList.remove('triple-shot-glow');
                box.classList.remove('hammer-shot-glow'); // إزالة توهج المطرقة
            });

            showMessage('انتهت الجولة! اضغط "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" لبدء جولة جديدة.');
            updateActionButtonsState(); 
        }

        // وظيفة بدء وضع التلقائي (Auto Play) - يفتح صندوقًا واحدًا
        function startAutoPlay() {
            if (personalScore < AUTO_PLAY_COST) {
                showMessage(`نقاطك الحالية (${personalScore}) لا تكفي لاستخدام "تلقائي" التي تتطلب ${AUTO_PLAY_COST} نقاط.`, true);
                return;
            }

            const remainingVisibleBoxes = boxes.filter(box => box.parentNode === boxesContainer).length;
            if (boxes.length === 0 || remainingVisibleBoxes === 0) { 
                startNewRound().then(() => setTimeout(() => handleAutoPlay(1, AUTO_PLAY_COST, 'auto-glow'), 100)); 
                return; 
            }

            handleAutoPlay(1, AUTO_PLAY_COST, 'auto-glow');
        }

        // وظيفة بدء وضع الضربة الثلاثية (Triple Shot) - تفتح 3 صناديق
        function startTripleShot() {
            const BOXES_TO_OPEN_TRIPLE_SHOT = 3; 

            if (personalScore < TRIPLE_SHOT_COST) {
                showMessage(`نقاطك الحالية (${personalScore}) لا تكفي لاستخدام "ضربة ثلاثية" التي تتطلب ${TRIPLE_SHOT_COST} نقاط.`, true);
                return;
            }

            const remainingVisibleBoxes = boxes.filter(box => box.parentNode === boxesContainer).length;
            if (remainingVisibleBoxes < BOXES_TO_OPEN_TRIPLE_SHOT) {
                showMessage(`لا يوجد ما يكفي من الصناديق المتبقية (${remainingVisibleBoxes}) لـ "ضربة ثلاثية" التي تتطلب ${BOXES_TO_OPEN_TRIPLE_SHOT} صناديق.`, true);
                return;
            }
            
            if (boxes.length === 0 || remainingVisibleBoxes === 0) { 
                startNewRound().then(() => setTimeout(() => handleAutoPlay(BOXES_TO_OPEN_TRIPLE_SHOT, TRIPLE_SHOT_COST, 'triple-shot-glow'), 100)); 
                return; 
            }

            handleAutoPlay(BOXES_TO_OPEN_TRIPLE_SHOT, TRIPLE_SHOT_COST, 'triple-shot-glow');
        }

        // وظيفة بدء ضربة المطرقة (Hammer Shot) - تفتح 15 صندوق
        function startHammerShot() {
            if (personalScore < HAMMER_SHOT_COST) {
                showMessage(`نقاطك الحالية (${personalScore}) لا تكفي لاستخدام "ضربة المطرقة" التي تتطلب ${HAMMER_SHOT_COST} نقاط.`, true);
                return;
            }

            const remainingVisibleBoxes = boxes.filter(box => box.parentNode === boxesContainer).length;
            if (remainingVisibleBoxes < HAMMER_SHOT_BOXES) {
                showMessage(`لا يوجد ما يكفي من الصناديق المتبقية (${remainingVisibleBoxes}) لـ "ضربة المطرقة" التي تتطلب ${HAMMER_SHOT_BOXES} صناديق.`, true);
                return;
            }

            if (boxes.length === 0 || remainingVisibleBoxes === 0) { 
                startNewRound().then(() => setTimeout(() => handleAutoPlay(HAMMER_SHOT_BOXES, HAMMER_SHOT_COST, 'hammer-shot-glow'), 100)); 
                return; 
            }

            handleAutoPlay(HAMMER_SHOT_BOXES, HAMMER_SHOT_COST, 'hammer-shot-glow');
        }

        // وظيفة مساعدة عامة لـ "تلقائي" و "ضربة ثلاثية" و "ضربة المطرقة" (معدلة لعرض رسالة مجمعة)
        function handleAutoPlay(boxesToOpenCount, cost, glowClass) {
            autoPlayButton.disabled = true;
            tripleShotButton.disabled = true;
            hammerShotButton.disabled = true; // تعطيل زر المطرقة
            clearInterval(autoPlayInterval); 

            const unopenedBoxes = boxes.filter(box => !box.classList.contains('opened') && box.parentNode === boxesContainer);
            if (unopenedBoxes.length === 0) {
                showMessage('لا توجد صناديق متبقية لفتحها تلقائيًا.', true);
                endRound();
                return;
            }
            if (unopenedBoxes.length < boxesToOpenCount) {
                showMessage(`لا يوجد ما يكفي من الصناديق المتبقية (${unopenedBoxes.length}) لفتحها.`, true);
                updateActionButtonsState(); 
                return;
            }

            // خصم التكلفة
            personalScore -= cost;
            updateScoreBoard();
            showMessage(`تم خصم ${cost} نقاط من رصيدك.`);

            showMessage('وضع التلقائي قيد التشغيل...');
            
            // تحديد الصناديق التي سيتم فتحها مسبقًا
            const shuffledUnopened = [...unopenedBoxes].sort(() => 0.5 - Math.random());
            const boxesToOpenSequentially = shuffledUnopened.slice(0, boxesToOpenCount);

            let currentGlowIndex = 0;
            let openedCount = 0;
            let totalPointsFromAutoPlay = 0;
            let openingBox = false; // flag to prevent glowing during box opening

            const highlightIntervalTime = 150; // سرعة الإضاءة

            // وظيفة لإدارة عملية الإضاءة وفتح الصناديق بالتتابع
            function manageSequence() {
                if (openedCount < boxesToOpenSequentially.length) {
                    if (!openingBox) {
                        // إضاءة الصناديق غير المفتوحة
                        boxes.forEach(box => {
                            box.classList.remove('auto-glow');
                            box.classList.remove('triple-shot-glow');
                            box.classList.remove('hammer-shot-glow'); // إزالة توهج المطرقة
                        });

                        const currentUnopenedForGlow = boxes.filter(box => !box.classList.contains('opened') && box.parentNode === boxesContainer);
                        if (currentUnopenedForGlow.length > 0) {
                            const boxToGlow = currentUnopenedForGlow[currentGlowIndex % currentUnopenedForGlow.length];
                            boxToGlow.classList.add(glowClass);
                            currentGlowIndex++;
                        }
                    }
                } else {
                    // جميع الصناديق المطلوبة تم فتحها
                    clearInterval(autoPlayInterval);
                    autoPlayIndex = 0;
                    boxes.forEach(box => {
                        box.classList.remove('auto-glow');
                        box.classList.remove('triple-shot-glow');
                        box.classList.remove('hammer-shot-glow'); // إزالة توهج المطرقة
                    });

                    personalScore += totalPointsFromAutoPlay;
                    currentRoundPoints += totalPointsFromAutoPlay;
                    updateScoreBoard();

                    if (totalPointsFromAutoPlay >= 0) {
                        showMessage(`تم فتح ${boxesToOpenCount} صندوق. لقد ربحت إجمالي ${totalPointsFromAutoPlay} نقطة!`, false, true); // رسالة فوز
                    } else {
                        showMessage(`تم فتح ${boxesToOpenCount} صندوق. لقد خسرت إجمالي ${Math.abs(totalPointsFromAutoPlay)} نقطة (ضريبة).`, true, false); // رسالة خسارة
                    }
                    
                    const remainingAfterSequence = boxes.filter(b => b.parentNode === boxesContainer).length;
                    if (remainingAfterSequence === 0) {
                        endRound();
                    } else {
                        updateActionButtonsState();
                    }
                    return;
                }

                // فتح الصندوق التالي بعد فترة انتظار
                if (currentGlowIndex % 10 === 0 && openedCount < boxesToOpenSequentially.length && !openingBox) { // افتح صندوقًا كل 10 إضاءات (يمكنك ضبط هذا الرقم)
                    openingBox = true; // Set flag to prevent glowing during opening
                    boxes.forEach(box => { // Remove glows before opening the box
                        box.classList.remove('auto-glow');
                        box.classList.remove('triple-shot-glow');
                        box.classList.remove('hammer-shot-glow'); // إزالة توهج المطرقة
                    });

                    setTimeout(() => {
                        const boxToOpen = boxesToOpenSequentially[openedCount];
                        const pointsEarned = openBox(boxToOpen);
                        totalPointsFromAutoPlay += pointsEarned;
                        openedCount++;
                        openingBox = false; // Reset flag after opening

                        // إذا كان لا يزال هناك صناديق لفتحها، استمر في الإضاءة
                        if (openedCount < boxesToOpenSequentially.length) {
                             showMessage(`يتم فتح الصندوق ${openedCount + 1} من ${boxesToOpenCount}...`);
                        } else {
                             // يتم إنهاء العملية في بداية الدالة manageSequence عندما openedCount يصل للعدد المطلوب
                        }
                    }, 2000); // ثانيتين تأخير قبل فتح الصندوق
                }
            }

            // بدء حلقة الإضاءة وفتح الصناديق
            autoPlayInterval = setInterval(manageSequence, highlightIntervalTime);
        }
        
        // وظيفة حفظ الإعدادات (للمشرف)
        async function saveSettings() {
            const newNumBoxes = parseInt(numBoxesInput.value);
            const newNum10PointsBoxes = parseInt(num10PointsBoxesInput.value);
            const newNum5PointsBoxes = parseInt(num5PointsBoxesInput.value);
            const newNum1PointsBoxes = parseInt(num1PointsBoxesInput.value);
            const newNumNegative5PointsBoxes = parseInt(numNegative5PointsBoxesInput.value);
            const newNumNegative10PointsBoxes = parseInt(numNegative10PointsBoxesInput.value);

            if (isNaN(newNumBoxes) || newNumBoxes < 5 || newNumBoxes > 100) {
                showMessage('عدد الصناديق يجب أن يكون بين 5 و 100.', true);
                return;
            }
            if (isNaN(newNum10PointsBoxes) || newNum10PointsBoxes < 0 ||
                isNaN(newNum5PointsBoxes) || newNum5PointsBoxes < 0 ||
                isNaN(newNum1PointsBoxes) || newNum1PointsBoxes < 0 ||
                isNaN(newNumNegative5PointsBoxes) || newNumNegative5PointsBoxes < 0 ||
                isNaN(newNumNegative10PointsBoxes) || newNumNegative10PointsBoxes < 0) {
                showMessage('عدد الصناديق لكل قيمة نقطية يجب أن يكون رقماً صحيحاً غير سالب.', true);
                return;
            }

            const totalSpecifiedBoxes = newNum10PointsBoxes + newNum5PointsBoxes + newNum1PointsBoxes +
                                       newNumNegative5PointsBoxes + newNumNegative10PointsBoxes;

            if (totalSpecifiedBoxes > newNumBoxes) {
                showMessage(`تنبيه: مجموع الصناديق المحددة (${totalSpecifiedBoxes}) يتجاوز العدد الكلي للصناديق (${newNumBoxes}). يرجى تعديل الأعداد ليتساوى المجموع أو يكون أقل.`, true);
                return;
            }

            try {
                const response = await fetch('/api/saveSettings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        numBoxes: newNumBoxes, 
                        num10PointsBoxes: newNum10PointsBoxes,
                        num5PointsBoxes: newNum5PointsBoxes,
                        num1PointsBoxes: newNum1PointsBoxes,
                        numNegative5PointsBoxes: numNegative5PointsBoxes,
                        numNegative10PointsBoxes: numNegative10PointsBoxes
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    showMessage('تم حفظ الإعدادات بنجاح!', false, true); // رسالة نجاح بلون أخضر
                    numBoxes = newNumBoxes;
                    num10PointsBoxes = newNum10PointsBoxes;
                    num5PointsBoxes = newNum5PointsBoxes;
                    num1PointsBoxes = newNum1PointsBoxes;
                    numNegative5PointsBoxes = numNegative5PointsBoxes;
                    numNegative10PointsBoxes = numNegative10PointsBoxes;

                    updateScoreBoard();
                    generateBoxes();
                } else {
                    showMessage('خطأ في حفظ الإعدادات: ' + data.message, true);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('حدث خطأ غير متوقع عند حفظ الإعدادات.', true);
            }
        }

        // وظيفة إعادة تعيين اللعبة (للمشرف)
        async function resetGame() {
            if (!confirm('هل أنت متأكد من إعادة تعيين جميع بيانات اللعبة (نقاط المستخدمين، الجولات، الإعدادات)؟ هذا الإجراء لا يمكن التراجع عنه!')) {
                return;
            }

            try {
                const response = await fetch('/api/resetAllUsers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (response.ok) {
                    showMessage('تمت إعادة تعيين اللعبة وجميع المستخدمين بنجاح!', false, true); // رسالة نجاح بلون أخضر
                    personalScore = 0;
                    highScore = 0;
                    roundNumber = 0;
                    currentRoundPoints = 0;
                    
                    numBoxes = 10;
                    num10PointsBoxes = 1;
                    num5PointsBoxes = 2;
                    num1PointsBoxes = 3;
                    numNegative5PointsBoxes = 1;
                    numNegative10PointsBoxes = 0;

                    numBoxesInput.value = numBoxes;
                    num10PointsBoxesInput.value = num10PointsBoxes;
                    num5PointsBoxesInput.value = num5PointsBoxes;
                    num1PointsBoxesInput.value = num1PointsBoxes;
                    numNegative5PointsBoxesInput.value = numNegative5PointsBoxes;
                    numNegative10PointsBoxesInput.value = numNegative10PointsBoxes;

                    updateScoreBoard();
                    generateBoxes();
                    updateActionButtonsState(); 
                } else {
                    showMessage('خطأ في إعادة تعيين اللعبة: ' + data.message, true);
                }
            } catch (error) {
                console.error('Error resetting game:', error);
                showMessage('حدث خطأ غير متوقع عند إعادة تعيين اللعبة.', true);
            }
        }

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async () => {
            username = localStorage.getItem('username');
            isAdmin = localStorage.getItem('isAdmin') === 'true';

            if (username) {
                usernameDisplay.textContent = username;
                setVolume(volumeSlider.value);
                
                try {
                    const response = await fetch(`/api/gameData?username=${username}`);
                    if (response.ok) {
                        const data = await response.json();
                        settings = data.settings;
                        personalScore = data.user.personalScore;
                        highScore = data.user.highScore;
                        roundNumber = data.user.roundNumber;
                        
                        numBoxes = settings.numBoxes;
                        num10PointsBoxes = settings.num10PointsBoxes;
                        num5PointsBoxes = settings.num5PointsBoxes;
                        num1PointsBoxes = settings.num1PointsBoxes;
                        numNegative5PointsBoxes = settings.numNegative5PointsBoxes;
                        numNegative10PointsBoxes = settings.numNegative10PointsBoxes;

                        numBoxesInput.value = numBoxes;
                        num10PointsBoxesInput.value = num10PointsBoxes;
                        num5PointsBoxesInput.value = num5PointsBoxes;
                        num1PointsBoxesInput.value = num1PointsBoxes;
                        numNegative5PointsBoxesInput.value = numNegative5PointsBoxes;
                        numNegative10PointsBoxesInput.value = numNegative10PointsBoxes;

                        currentRoundPoints = 0;
                        updateScoreBoard();
                        generateBoxes();
                        showMessage('اضغط "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" للكشف عن النقاط!');
                        updateActionButtonsState(); 

                    } else {
                        const errorText = await response.text();
                        console.error('Error fetching game data (HTTP Error):', response.status, errorText);
                        showMessage('خطأ في تحميل بيانات اللعبة الأولية: ' + (errorText.length > 100 ? errorText.substring(0, 100) : errorText), true);
                        
                        numBoxesInput.value = numBoxes;
                        num10PointsBoxesInput.value = num10PointsBoxes;
                        num5PointsBoxesInput.value = num5PointsBoxes;
                        num1PointsBoxesInput.value = num1PointsBoxes;
                        numNegative5PointsBoxesInput.value = numNegative5PointsBoxes;
                        numNegative10PointsBoxesInput.value = numNegative10PointsBoxes;
                        currentRoundPoints = 0;
                        updateScoreBoard();
                        generateBoxes();
                        updateActionButtonsState(); 
                    }
                } catch (error) {
                    console.error('Error fetching game data (Network/Parsing Error):', error);
                    showMessage('حدث خطأ غير متوقع عند تحميل بيانات اللعبة الأولية.', true);
                    
                    numBoxesInput.value = numBoxes;
                    num10PointsBoxesInput.value = num10PointsBoxes;
                    num5PointsBoxesInput.value = num5PointsBoxes;
                    num1PointsBoxesInput.value = num1PointsBoxes;
                    numNegative5PointsBoxesInput.value = numNegative5PointsBoxes;
                    numNegative10PointsBoxesInput.value = numNegative10PointsBoxes;
                    currentRoundPoints = 0;
                    updateScoreBoard();
                    generateBoxes();
                    updateActionButtonsState(); 
                }

                autoPlayButton.addEventListener('click', startAutoPlay); 
                tripleShotButton.addEventListener('click', startTripleShot); 
                hammerShotButton.addEventListener('click', startHammerShot); // إضافة مستمع حدث لزر ضربة المطرقة
                saveSettingsBtn.addEventListener('click', saveSettings);
                resetGameBtn.addEventListener('click', resetGame);
                logoutButton.addEventListener('click', () => {
                    localStorage.clear();
                    window.location.href = 'index.html';
                });

                volumeSlider.addEventListener('input', updateVolumeFromSlider);
                document.getElementById('increaseVolumeBtn').addEventListener('click', increaseVolume);
                document.getElementById('decreaseVolumeBtn').addEventListener('click', decreaseVolume);
                document.getElementById('muteToggleBtn').addEventListener('click', toggleMute);
                
                if (isAdmin) {
                    toggleBtn.style.display = 'block';
                    settingsArea.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
                    showMessage('اضغط "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" للكشف عن النقاط!');
                    
                    toggleBtn.addEventListener('click', () => {
                        if (settingsArea.style.display === 'none') {
                            settingsArea.style.display = 'block';
                            toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء الإعدادات';
                        } else {
                            settingsArea.style.display = 'none';
                            toggleBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
                        }
                    });

                } else {
                    toggleBtn.style.display = 'none';
                    settingsArea.style.display = 'none';
                    showMessage('اضغط "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" للكشف عن النقاط!');
                }

                updateButtonVisibility();
                updateActionButtonsState(); 
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>