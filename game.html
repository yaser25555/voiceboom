<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Voice Boom</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            overflow-x: hidden;
            position: relative;
            z-index: 0;

            background-image: url('background_image.jpg'); /* هذا سيتغير بواسطة JS من إعدادات السيرفر */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }

        .container {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            text-align: center;
            max-width: 900px;
            width: 100%;
            z-index: 1;
            border: 2px solid cyan;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #00FFFF;
            margin-bottom: 15px;
        }

        .user-info, .game-area, .game-controls, .game-message-box, .logout-area {
            background-color: rgba(0, 100, 100, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #00FFFF;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .user-info p {
            margin: 5px 0;
            font-size: 1.1em;
            color: #E0E0E0;
        }

        .admin-panel-link {
            display: none; /* يتم التحكم في إظهاره بواسطة JavaScript */
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }

        .admin-panel-link:hover {
            background-color: #218838;
        }

        .game-buttons button, .admin-buttons button, .action-buttons button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .game-buttons button:hover, .admin-buttons button:hover, .action-buttons button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .game-buttons button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .game-message-box {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: bold;
            color: #FFD700; /* لون ذهبي للرسائل */
            border: 2px dashed #00FFFF;
            box-shadow: inset 0 0 15px rgba(255, 255, 0, 0.3);
            text-shadow: 1px 1px 5px rgba(0, 255, 255, 0.7);
        }

        .settings-area, .admin-section {
            background-color: rgba(0, 50, 50, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #00FFFF;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
            text-align: right;
        }

        .settings-area label {
            display: block;
            margin-bottom: 8px;
            color: #E0E0E0;
            font-size: 1.1em;
        }

        .settings-area input[type="number"],
        .settings-area input[type="text"],
        .settings-area select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #00FFFF;
            background-color: rgba(0, 0, 0, 0.5);
            color: #E0E0E0;
            font-size: 1em;
        }

        .settings-area button {
            background-color: #17a2b8; /* لون أزرق سماوي للإعدادات */
        }

        .settings-area button:hover {
            background-color: #138496;
        }

        .admin-section h2 {
            color: #00FFFF;
            border-bottom: 1px solid #00FFFF;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .admin-section .user-list {
            margin-top: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px dashed #00FFFF;
        }

        .admin-section .user-item {
            background-color: rgba(0, 200, 200, 0.1);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 255, 255, 0.5);
        }

        .admin-section .user-item span {
            color: #E0E0E0;
            flex-grow: 1;
            text-align: right;
        }

        .admin-section .user-item button {
            margin-right: 5px; /* Adjust margin for left-to-right alignment of buttons */
            background-color: #ffc107; /* لون أصفر */
            color: #333;
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .admin-section .user-item button.delete-btn {
            background-color: #dc3545; /* لون أحمر */
            color: white;
        }

        .admin-section .user-item button:hover {
            opacity: 0.8;
        }
        
        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            margin-top: 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .logout-btn:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Voice Boom Game</h1>
        
        <div class="user-info">
            <p>مرحباً بك، <span id="usernameDisplay"></span>!</p>
            <p>العملات: <span id="playerCoinsDisplay"></span></p>
            <p>نقاط الحظ: <span id="luckyPointsDisplay"></span></p>
            <p>جولات لعبت: <span id="roundsPlayedDisplay"></span></p>
            <a href="admin.html" id="adminPanelLink" class="admin-panel-link">لوحة المدير</a>
        </div>

        <div class="game-area">
            <h2>ابدأ اللعب</h2>
            <div class="game-buttons">
                <button id="autoPlayBtn">لعب تلقائي</button>
                <button id="tripleStrikeBtn">ضربة ثلاثية</button>
                <button id="hammerStrikeBtn">ضربة المطرقة</button>
            </div>
            <div class="game-message-box">
                <p id="gameMessage">اضغط "تلقائي" أو "ضربة ثلاثية" أو "ضربة المطرقة" للكشف عن النقاط!</p>
            </div>
        </div>

        <div id="settingsArea" class="settings-area" style="display: none;">
            <h2>إعدادات اللعبة</h2>
            <label for="initialCoins">العملات الأولية:</label>
            <input type="number" id="initialCoins" placeholder="مثال: 500"><br>
            
            <label for="autoPlayCost">تكلفة اللعب التلقائي:</label>
            <input type="number" id="autoPlayCost" placeholder="مثال: 20"><br>

            <label for="tripleStrikeCost">تكلفة الضربة الثلاثية:</label>
            <input type="number" id="tripleStrikeCost" placeholder="مثال: 30"><br>

            <label for="hammerStrikeCost">تكلفة ضربة المطرقة:</label>
            <input type="number" id="hammerStrikeCost" placeholder="مثال: 5 نقاط حظ"><br>

            <label for="autoPlayRewardMin">جائزة اللعب التلقائي (الحد الأدنى):</label>
            <input type="number" id="autoPlayRewardMin" placeholder="مثال: 10"><br>

            <label for="autoPlayRewardMax">جائزة اللعب التلقائي (الحد الأقصى):</label>
            <input type="number" id="autoPlayRewardMax" placeholder="مثال: 50"><br>

            <label for="tripleStrikeReward">جائزة الضربة الثلاثية (ثابتة):</label>
            <input type="number" id="tripleStrikeReward" placeholder="مثال: 100"><br>

            <label for="hammerStrikeReward">جائزة ضربة المطرقة (ثابتة):</label>
            <input type="number" id="hammerStrikeReward" placeholder="مثال: 500"><br>

            <label for="adminRewardMultiplier">مضاعف جائزة المدير:</label>
            <input type="number" id="adminRewardMultiplier" step="0.1" placeholder="مثال: 1.5"><br>

            <label for="backgroundUrl">رابط صورة الخلفية:</label>
            <input type="text" id="backgroundUrl" placeholder="مثال: https://example.com/bg.jpg"><br>

            <label for="soundUrl">رابط ملف الصوت:</label>
            <input type="text" id="soundUrl" placeholder="مثال: https://example.com/music.mp3"><br>

            <button id="saveSettingsBtn"><i class="fas fa-save"></i> حفظ الإعدادات</button>
            <button id="resetGameBtn"><i class="fas fa-redo"></i> إعادة تعيين اللعبة (لجميع المستخدمين)</button>
            <button id="muteToggleBtn"><i class="fas fa-volume-up"></i> كتم/تشغيل الصوت</button>
        </div>

        <button id="toggleSettingsBtn" class="game-buttons" style="display: none; margin-top: 20px;"><i class="fas fa-cog"></i> إظهار/إخفاء الإعدادات</button>
        
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
    </div>

    <audio id="gameSound" loop autoplay></audio>

    <script>
        const backendUrl = 'https://voiceboom-wlxp.onrender.com'; // تأكد من أن هذا هو رابط الواجهة الخلفية الصحيح الخاص بك
        const gameMessageElement = document.getElementById('gameMessage');
        const gameSoundElement = document.getElementById('gameSound');

        // عناصر واجهة المستخدم لعرض بيانات اللاعب
        const usernameDisplay = document.getElementById('usernameDisplay');
        const playerCoinsDisplay = document.getElementById('playerCoinsDisplay');
        const luckyPointsDisplay = document.getElementById('luckyPointsDisplay');
        const roundsPlayedDisplay = document.getElementById('roundsPlayedDisplay');
        const adminPanelLink = document.getElementById('adminPanelLink');

        // عناصر التحكم في اللعبة
        const autoPlayBtn = document.getElementById('autoPlayBtn');
        const tripleStrikeBtn = document.getElementById('tripleStrikeBtn');
        const hammerStrikeBtn = document.getElementById('hammerStrikeBtn');

        // عناصر إعدادات المدير
        const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
        const settingsArea = document.getElementById('settingsArea');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const muteToggleBtn = document.getElementById('muteToggleBtn');

        // حقول إعدادات اللعبة
        const initialCoinsInput = document.getElementById('initialCoins');
        const autoPlayCostInput = document.getElementById('autoPlayCost');
        const tripleStrikeCostInput = document.getElementById('tripleStrikeCost');
        const hammerStrikeCostInput = document.getElementById('hammerStrikeCost');
        const autoPlayRewardMinInput = document.getElementById('autoPlayRewardMin');
        const autoPlayRewardMaxInput = document.getElementById('autoPlayRewardMax');
        const tripleStrikeRewardInput = document.getElementById('tripleStrikeReward');
        const hammerStrikeRewardInput = document.getElementById('hammerStrikeReward');
        const adminRewardMultiplierInput = document.getElementById('adminRewardMultiplier');
        const backgroundUrlInput = document.getElementById('backgroundUrl');
        const soundUrlInput = document.getElementById('soundUrl');

        let isMuted = false;

        // ----------------------------------------------------
        // وظائف عامة
        // ----------------------------------------------------
        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html'; // أو صفحة تسجيل الدخول الخاصة بك
        }

        function displayGameMessage(message, type = 'info') {
            gameMessageElement.textContent = message;
            gameMessageElement.style.color = type === 'error' ? '#dc3545' : '#FFD700';
        }

        function updateUI(userData) {
            usernameDisplay.textContent = userData.username;
            playerCoinsDisplay.textContent = userData.playerCoins;
            luckyPointsDisplay.textContent = userData.luckyPoints;
            roundsPlayedDisplay.textContent = userData.roundsPlayed;

            // إظهار/إخفاء رابط لوحة المدير وزر إظهار الإعدادات
            if (userData.isAdmin) {
                adminPanelLink.style.display = 'inline-block';
                toggleSettingsBtn.style.display = 'inline-block';
            } else {
                adminPanelLink.style.display = 'none';
                toggleSettingsBtn.style.display = 'none';
                settingsArea.style.display = 'none'; // تأكد من إخفاء الإعدادات إذا لم يكن مديراً
            }
            updateActionButtonsState(userData); // تحديث حالة الأزرار بناءً على عملات اللاعب
        }

        function updateActionButtonsState(userData) {
            autoPlayBtn.disabled = userData.playerCoins < (parseFloat(autoPlayCostInput.value) || 20); // يستخدم القيمة من الإعدادات
            tripleStrikeBtn.disabled = userData.playerCoins < (parseFloat(tripleStrikeCostInput.value) || 30);
            hammerStrikeBtn.disabled = userData.luckyPoints < (parseFloat(hammerStrikeCostInput.value) || 5);
        }
        
        function toggleMute() {
            isMuted = !isMuted;
            if (isMuted) {
                gameSoundElement.pause();
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i> تشغيل الصوت';
            } else {
                gameSoundElement.play().catch(e => console.log("Autoplay prevented:", e));
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i> كتم الصوت';
            }
        }


        // ----------------------------------------------------
        // جلب بيانات المستخدم وإعدادات اللعبة
        // ----------------------------------------------------
        async function fetchUserDataAndSettings() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('الرجاء تسجيل الدخول.');
                window.location.href = 'index.html';
                return;
            }

            try {
                // جلب بيانات المستخدم
                const userResponse = await fetch(`${backendUrl}/api/user/data`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token
                    }
                });
                const userData = await userResponse.json();

                if (!userResponse.ok) {
                    console.error('Failed to fetch user data:', userData.message);
                    if (userResponse.status === 401) {
                        alert('جلسة المستخدم انتهت، الرجاء تسجيل الدخول مرة أخرى.');
                        window.location.href = 'index.html';
                    } else {
                        alert('فشل في جلب بيانات المستخدم: ' + userData.message);
                    }
                    return;
                }
                updateUI(userData); // تحديث معلومات المستخدم في الواجهة

                // جلب إعدادات اللعبة (يحتاج مسار خاص بالإعدادات)
                const settingsResponse = await fetch(`${backendUrl}/api/admin/settings`, { // هذا المسار يتطلب أن يكون المستخدم مديراً!
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token
                    }
                });
                const settingsData = await settingsResponse.json();

                if (settingsResponse.ok) {
                    // ملء حقول الإعدادات في الواجهة (للمدير)
                    initialCoinsInput.value = settingsData.initialCoins;
                    autoPlayCostInput.value = settingsData.autoPlayCost;
                    tripleStrikeCostInput.value = settingsData.tripleStrikeCost;
                    hammerStrikeCostInput.value = settingsData.hammerStrikeCost;
                    autoPlayRewardMinInput.value = settingsData.autoPlayRewardMin;
                    autoPlayRewardMaxInput.value = settingsData.autoPlayRewardMax;
                    tripleStrikeRewardInput.value = settingsData.tripleStrikeReward;
                    hammerStrikeRewardInput.value = settingsData.hammerStrikeReward;
                    adminRewardMultiplierInput.value = settingsData.adminRewardMultiplier;
                    backgroundUrlInput.value = settingsData.currentBackgroundUrl;
                    soundUrlInput.value = settingsData.currentSoundUrl;

                    // تطبيق الخلفية
                    if (settingsData.currentBackgroundUrl) {
                        document.body.style.backgroundImage = `url('${settingsData.currentBackgroundUrl}')`;
                    } else {
                        document.body.style.backgroundImage = `url('background_image.jpg')`; // خلفية افتراضية
                    }
                    
                    // تطبيق الصوت
                    if (settingsData.currentSoundUrl) {
                        gameSoundElement.src = settingsData.currentSoundUrl;
                        if (!isMuted) { // تشغيل فقط إذا لم يتم كتم الصوت يدوياً
                             gameSoundElement.play().catch(e => console.log('Autoplay prevented:', e));
                        }
                    } else {
                        gameSoundElement.pause(); // لا يوجد صوت إذا لم يتم تحديده
                    }

                    updateActionButtonsState(userData); // تحديث الأزرار بناءً على الإعدادات الجديدة والعملات
                } else {
                    console.warn('Could not fetch game settings (this is normal if not an admin):', settingsData.message);
                    // إذا لم يتمكن المستخدم من جلب الإعدادات (لأنه ليس مديراً)، يجب أن نستخدم القيم الافتراضية
                    // أو القيم المخزنة محلياً إذا كانت الإعدادات الأساسية ضرورية للعب كلاعب عادي
                    updateActionButtonsState(userData); // تحديث الأزرار بناءً على القيم الافتراضية إذا لم يتم جلب الإعدادات
                }

            } catch (error) {
                console.error('Error fetching data or settings:', error);
                alert('حدث خطأ في الاتصال بالخادم.');
            }
        }

        // ----------------------------------------------------
        // وظائف إجراءات اللعبة (مثلا auto-play)
        // ----------------------------------------------------
        async function performGameAction(actionType) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('الرجاء تسجيل الدخول للعب.');
                window.location.href = 'index.html';
                return;
            }

            displayGameMessage('جاري معالجة طلبك...');

            try {
                const response = await fetch(`${backendUrl}/api/user/${actionType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token
                    }
                });
                const result = await response.json();

                if (response.ok) {
                    displayGameMessage(result.message);
                    updateUI(result); // تحديث العملات والنقاط في الواجهة
                } else {
                    displayGameMessage(result.message, 'error');
                    if (response.status === 401) {
                        alert('جلسة المستخدم انتهت، الرجاء تسجيل الدخول مرة أخرى.');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error(`Error performing ${actionType}:`, error);
                displayGameMessage('حدث خطأ في الاتصال بالخادم أثناء اللعب.', 'error');
            }
        }

        // ----------------------------------------------------
        // وظائف إعدادات المدير
        // ----------------------------------------------------
        async function saveSettings() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('لا يمكن حفظ الإعدادات: غير مصرح لك.');
                window.location.href = 'index.html';
                return;
            }

            const settings = {
                initialCoins: parseFloat(initialCoinsInput.value),
                autoPlayCost: parseFloat(autoPlayCostInput.value),
                tripleStrikeCost: parseFloat(tripleStrikeCostInput.value),
                hammerStrikeCost: parseFloat(hammerStrikeCostInput.value),
                autoPlayRewardMin: parseFloat(autoPlayRewardMinInput.value),
                autoPlayRewardMax: parseFloat(autoPlayRewardMaxInput.value),
                tripleStrikeReward: parseFloat(tripleStrikeRewardInput.value),
                hammerStrikeReward: parseFloat(hammerStrikeRewardInput.value),
                adminRewardMultiplier: parseFloat(adminRewardMultiplierInput.value),
                currentBackgroundUrl: backgroundUrlInput.value,
                currentSoundUrl: soundUrlInput.value
            };

            displayGameMessage('جاري حفظ الإعدادات...');

            try {
                const response = await fetch(`${backendUrl}/api/admin/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token
                    },
                    body: JSON.stringify(settings)
                });
                const result = await response.json();

                if (response.ok) {
                    displayGameMessage(result.message, 'info');
                    fetchUserDataAndSettings(); // إعادة جلب البيانات لتطبيق التغييرات فورا
                } else {
                    displayGameMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                displayGameMessage('حدث خطأ في الاتصال بالخادم أثناء حفظ الإعدادات.', 'error');
            }
        }

        async function resetGameForUsers() {
            if (!confirm('هل أنت متأكد أنك تريد إعادة تعيين اللعبة لجميع المستخدمين؟ هذا لا يمكن التراجع عنه!')) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                alert('لا يمكن إعادة تعيين اللعبة: غير مصرح لك.');
                window.location.href = 'index.html';
                return;
            }

            displayGameMessage('جاري إعادة تعيين اللعبة لجميع المستخدمين...');

            try {
                const response = await fetch(`${backendUrl}/api/admin/reset-all-users`, { // تأكد من هذا المسار في الـ backend
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token
                    }
                });
                const result = await response.json();

                if (response.ok) {
                    displayGameMessage(result.message, 'info');
                    fetchUserDataAndSettings(); // تحديث بيانات المستخدم الحالي بعد إعادة التعيين
                } else {
                    displayGameMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error resetting game:', error);
                displayGameMessage('حدث خطأ في الاتصال بالخادم أثناء إعادة تعيين اللعبة.', 'error');
            }
        }

        // ----------------------------------------------------
        // ربط الأحداث
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', fetchUserDataAndSettings);
        
        autoPlayBtn.addEventListener('click', () => performGameAction('auto-play'));
        tripleStrikeBtn.addEventListener('click', () => performGameAction('triple-strike'));
        hammerStrikeBtn.addEventListener('click', () => performGameAction('hammer-strike'));

        toggleSettingsBtn.addEventListener('click', () => {
            if (settingsArea.style.display === 'none') {
                settingsArea.style.display = 'block';
                toggleSettingsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء الإعدادات';
            } else {
                settingsArea.style.display = 'none';
                toggleSettingsBtn.innerHTML = '<i class="fas fa-cog"></i> إظهار الإعدادات';
            }
        });

        saveSettingsBtn.addEventListener('click', saveSettings);
        resetGameBtn.addEventListener('click', resetGameForUsers);
        muteToggleBtn.addEventListener('click', toggleMute);

    </script>
</body>
</html>